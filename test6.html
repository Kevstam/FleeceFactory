<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleece Factory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #7c2d12 30%, #991b1b 70%, #0f172a 100%);
            min-height: 100vh;
            font-family: 'Oswald', sans-serif;
        }
        h1, h2, h3, .headline { font-family: 'Anton', sans-serif; letter-spacing: 2px; }
        .sheep-animation { display: inline-block; animation: sheep-jump 1s ease-in-out; }
        @keyframes sheep-jump {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-40px) rotate(0deg); }
        }
        .fleece-badge { background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%); }
        .fair-badge { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); }
        .questionable-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%); }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-6xl font-black text-white mb-2">
                <span class="bg-gradient-to-r from-red-500 via-orange-500 to-red-500 bg-clip-text text-transparent">FLEECE FACTORY</span>
            </h1>
            <p class="text-red-200 text-xl font-semibold">Exposing Dynasty League Robberies Since 2025</p>
        </div>

        <div id="inputSection" class="bg-gradient-to-br from-red-900/20 to-orange-900/20 backdrop-blur-md rounded-2xl p-8 mb-6 border-2 border-red-500/30">
            <div class="text-center mb-6">
                <div class="text-9xl mb-4 sheep-animation">üêë</div>
                <p class="text-red-200 text-lg font-semibold">Find out who got fleeced in your league!</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-red-200 text-sm font-semibold mb-3">Search by League ID</label>
                <div class="flex gap-3">
                    <input type="text" id="leagueId" placeholder="1181730976707772416" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white/10 border-2 border-red-400/30 text-white placeholder-red-300/50 focus:outline-none focus:border-red-400">
                    <button id="loadBtn" class="px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-semibold shadow-lg">
                        üèà Load League
                    </button>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <span class="text-red-300 text-sm">‚Äî OR ‚Äî</span>
            </div>
            
            <div>
                <label class="block text-red-200 text-sm font-semibold mb-3">Search by Username</label>
                <div class="flex gap-3">
                    <input type="text" id="usernameSearch" placeholder="Enter Sleeper username" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white/10 border-2 border-red-400/30 text-white placeholder-red-300/50 focus:outline-none focus:border-red-400">
                    <button id="searchUserBtn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-semibold shadow-lg">
                        üë§ Find User
                    </button>
                </div>
                <div id="userLeaguesSection" class="mt-4 hidden">
                    <label class="block text-red-200 text-sm font-semibold mb-2">Select a League:</label>
                    <div id="userLeaguesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            
            <div id="errorMsg" class="mt-4 text-red-400 text-sm hidden"></div>
            <div id="loadingMsg" class="mt-4 text-red-300 text-sm hidden">Loading...</div>
        </div>

        <div id="mainContent" class="hidden space-y-6">
            <div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
            
            <div class="bg-gradient-to-br from-red-900/30 to-orange-900/30 backdrop-blur-md rounded-2xl p-6 border-2 border-red-500/30">
                <h2 id="leagueName" class="text-3xl font-bold text-white"></h2>
                <p id="leagueInfo" class="text-red-300 mt-1"></p>
            </div>

            <div class="bg-gradient-to-br from-red-900/20 to-orange-900/20 backdrop-blur-md rounded-2xl p-2 border-2 border-red-500/30 flex flex-wrap gap-2" id="tabsSection"></div>

            <div id="filterSection" class="bg-gradient-to-br from-purple-900/20 to-pink-900/20 backdrop-blur-md rounded-2xl p-4 border-2 border-purple-500/30">
                <div class="flex items-center gap-3 flex-wrap">
                    <span class="font-bold headline text-purple-200">FILTER TRADES:</span>
                    <input type="text" id="usernameFilter" placeholder="Enter username to filter..." 
                        class="flex-1 min-w-[200px] px-4 py-2 rounded-lg bg-white/10 border-2 border-purple-400/30 text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400">
                    <button id="clearFilterBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-sm">
                        ‚úï Clear
                    </button>
                </div>
                <div id="filterStatus" class="mt-2 text-purple-300 text-sm hidden"></div>
            </div>

            <div class="bg-gradient-to-br from-red-900/20 to-orange-900/20 backdrop-blur-md rounded-2xl p-4 border-2 border-red-500/30 flex items-center justify-between">
                <span class="font-bold headline text-red-200">EXPORT REPORT</span>
                <div class="flex gap-2">
                    <button id="exportTextBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm">üìÑ Text</button>
                    <button id="exportCsvBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold text-sm">üìä CSV</button>
                </div>
            </div>

            <div id="contentArea"></div>
        </div>
    </div>

    <script>
        let players = {}, transactions = [], draftPicks = [], rosters = [], currentLeague = null, leagueUsers = {};
        let dpValues = {}; // DynastyProcess values
        let currentFilter = ''; // For username filtering

        // Load players and DP values
        fetch('https://api.sleeper.app/v1/players/nfl').then(r => r.json()).then(d => players = d);
        
        // Load DynastyProcess values via jsdelivr CDN (no CORS issues)
        fetch('https://cdn.jsdelivr.net/gh/dynastyprocess/data@master/files/values-players.csv')
            .then(r => r.text())
            .then(csv => {
                const lines = csv.trim().split('\n');
                const headerLine = lines[0];
                const headers = headerLine.split(',').map(h => h.trim());
                
                console.log('RAW HEADER LINE:', headerLine);
                console.log('PARSED HEADERS:', headers);
                
                // Find column indices - be flexible with header names
                let playerIdx = -1, value2qbIdx = -1, sleeperIdx = -1;
                headers.forEach((h, i) => {
                    const lower = h.toLowerCase();
                    console.log(`Column ${i}: "${h}" (lowercase: "${lower}")`);
                    
                    if (lower.includes('player') && !lower.includes('id')) playerIdx = i;
                    if (lower.includes('value') && lower.includes('2qb')) value2qbIdx = i;
                    if (lower.includes('sleeper') && lower.includes('id')) sleeperIdx = i;
                });
                
                console.log('FOUND Indices - player:', playerIdx, 'value_2qb:', value2qbIdx, 'sleeper_id:', sleeperIdx);
                
                if (playerIdx === -1 || value2qbIdx === -1) {
                    console.error('‚ùå Could not find required columns!');
                    console.log('Available columns:', headers);
                    alert('Error: CSV format not recognized. Check console for details.');
                    return;
                }
                
                // Parse each line
                let successCount = 0;
                let sleeperIdCount = 0;
                
                lines.slice(1).forEach((line, idx) => {
                    if (!line.trim()) return;
                    
                    const cols = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    
                    const playerName = cols[playerIdx];
                    const value = parseInt(cols[value2qbIdx]) || 0;
                    
                    if (value > 0 && playerName) {
                        // Normalize player name for better matching
                        const normalizedName = playerName.toLowerCase()
                            .replace(/\./g, '')
                            .replace(/'/g, '')
                            .replace(/-/g, ' ')
                            .replace(/\s+/g, ' ')
                            .replace(/\s+(jr|sr|ii|iii|iv)\.?$/i, '')
                            .trim();
                        
                        dpValues[normalizedName] = value;
                        successCount++;
                        
                        // Also store original name (lowercased)
                        dpValues[playerName.toLowerCase().trim()] = value;
                        
                        // Log specific players we're having trouble with
                        if (normalizedName.includes('mahomes') || normalizedName.includes('pittman') || 
                            normalizedName.includes('etienne') || normalizedName.includes('swift') ||
                            normalizedName.includes('robinson')) {
                            console.log(`Stored: "${playerName}" as "${normalizedName}" = ${value}`);
                        }
                    }
                });
                
                console.log('‚úÖ Loaded DP values:');
                console.log('  - By name:', successCount, 'players');
                console.log('  - By Sleeper ID:', sleeperIdCount, 'players');
                
                if (sleeperIdCount > 0) {
                    console.log('Sample entries:', Object.entries(dpValues).slice(0, 10));
                }
            })
            .catch(err => {
                console.error('‚ùå Error loading DP values:', err);
                alert('Warning: Could not load player values. Fleece scores will be estimates only.');
            });

        document.getElementById('loadBtn').addEventListener('click', async () => {
            const leagueId = document.getElementById('leagueId').value.trim();
            if (!leagueId) {
                showError('Please enter a league ID');
                return;
            }

            showLoading();
            hideError();

            try {
                const res = await fetch(`https://api.sleeper.app/v1/league/${leagueId}`);
                if (!res.ok) throw new Error('Not found');
                currentLeague = await res.json();
                
                document.getElementById('inputSection').classList.add('hidden');
                await loadData(leagueId);
                showContent();
            } catch (err) {
                showError('League not found');
            } finally {
                hideLoading();
            }
        });

        // Search by username
        document.getElementById('searchUserBtn').addEventListener('click', async () => {
            const username = document.getElementById('usernameSearch').value.trim();
            if (!username) {
                showError('Please enter a username');
                return;
            }

            showLoading();
            hideError();
            document.getElementById('userLeaguesSection').classList.add('hidden');

            try {
                // Get user info
                const userRes = await fetch(`https://api.sleeper.app/v1/user/${username}`);
                if (!userRes.ok) throw new Error('User not found');
                const user = await userRes.json();
                
                // Get user's leagues (2024 season)
                const leaguesRes = await fetch(`https://api.sleeper.app/v1/user/${user.user_id}/leagues/nfl/2024`);
                if (!leaguesRes.ok) throw new Error('Could not fetch leagues');
                const leagues = await leaguesRes.json();
                
                if (leagues.length === 0) {
                    showError('No leagues found for this user in 2024 season');
                    return;
                }
                
                // Display leagues
                const leaguesList = document.getElementById('userLeaguesList');
                leaguesList.innerHTML = leagues.map(league => `
                    <button class="w-full text-left px-4 py-3 bg-white/5 hover:bg-white/10 rounded-lg border border-red-400/30 text-white transition" 
                            onclick="loadLeagueById('${league.league_id}', '${league.name.replace(/'/g, "\\'")}')">
                        <div class="font-semibold">${league.name}</div>
                        <div class="text-sm text-red-300">${league.total_rosters} teams ‚Ä¢ ${league.settings.type === 2 ? 'Dynasty' : 'Redraft'}</div>
                    </button>
                `).join('');
                
                document.getElementById('userLeaguesSection').classList.remove('hidden');
                
            } catch (err) {
                showError(err.message || 'User not found');
            } finally {
                hideLoading();
            }
        });

        // Function to load league by ID (used by username search)
        async function loadLeagueById(leagueId, leagueName) {
            showLoading();
            hideError();
            
            try {
                const res = await fetch(`https://api.sleeper.app/v1/league/${leagueId}`);
                if (!res.ok) throw new Error('League not found');
                currentLeague = await res.json();
                
                document.getElementById('inputSection').classList.add('hidden');
                await loadData(leagueId);
                showContent();
            } catch (err) {
                showError('Error loading league');
            } finally {
                hideLoading();
            }
        }

        async function loadData(id) {
            const users = await fetch(`https://api.sleeper.app/v1/league/${id}/users`).then(r => r.json());
            rosters = await fetch(`https://api.sleeper.app/v1/league/${id}/rosters`).then(r => r.json());
            
            const userMap = {};
            users.forEach(u => userMap[u.user_id] = u);
            rosters.forEach(r => {
                const u = userMap[r.owner_id];
                leagueUsers[r.roster_id] = { username: u ? (u.display_name || u.username) : `Team ${r.roster_id}` };
            });

            transactions = [];
            for (let w = 1; w <= 18; w++) {
                try {
                    const data = await fetch(`https://api.sleeper.app/v1/league/${id}/transactions/${w}`).then(r => r.json());
                    if (data) transactions.push(...data);
                } catch {}
            }
            
            // Sort transactions by timestamp (oldest first) to process in chronological order
            transactions.sort((a, b) => a.created - b.created);
            
            // Track current ownership of players and picks throughout the season
            const playerOwnership = {}; // playerId -> rosterId
            const pickOwnership = {}; // "season-round-ownerId" -> rosterId
            
            // Initialize with current rosters
            rosters.forEach(roster => {
                if (roster.players) {
                    roster.players.forEach(playerId => {
                        playerOwnership[playerId] = roster.roster_id;
                    });
                }
                if (roster.draft_picks) {
                    roster.draft_picks.forEach(pick => {
                        const pickKey = `${pick.season}-${pick.round}-${pick.owner_id}`;
                        pickOwnership[pickKey] = roster.roster_id;
                    });
                }
            });
            
            // Filter to only trades
            transactions = transactions.filter(t => t.type === 'trade');
            
            // Process each trade to enrich with ownership info
            transactions.forEach(trade => {
                // For players being traded, determine who owned them before the trade
                if (trade.adds) {
                    const enhancedDrops = {};
                    Object.keys(trade.adds).forEach(playerId => {
                        const receivingRoster = trade.adds[playerId];
                        // Find who owned this player before (from our tracking or from drops)
                        const previousOwner = trade.drops?.[playerId] || playerOwnership[playerId];
                        if (previousOwner && previousOwner !== receivingRoster) {
                            enhancedDrops[playerId] = previousOwner;
                        }
                        // Update ownership tracking
                        playerOwnership[playerId] = receivingRoster;
                    });
                    
                    // Merge with existing drops data
                    trade.drops = { ...enhancedDrops, ...(trade.drops || {}) };
                }
                
                // For draft picks, the API already has previous_owner_id, but let's verify
                if (trade.draft_picks) {
                    trade.draft_picks.forEach(pick => {
                        const pickKey = `${pick.season}-${pick.round}-${pick.owner_id}`;
                        
                        // If previous_owner_id is missing, try to fill it from our tracking
                        if (!pick.previous_owner_id && pickOwnership[pickKey]) {
                            pick.previous_owner_id = pickOwnership[pickKey];
                        }
                        
                        // Update ownership tracking
                        pickOwnership[pickKey] = pick.roster_id;
                    });
                }
            });

            const drafts = await fetch(`https://api.sleeper.app/v1/league/${id}/drafts`).then(r => r.json());
            if (drafts?.[0]) {
                draftPicks = await fetch(`https://api.sleeper.app/v1/draft/${drafts[0].draft_id}/picks`).then(r => r.json()) || [];
            }
        }

        function showContent() {
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('leagueName').textContent = currentLeague.name;
            document.getElementById('leagueInfo').textContent = `${currentLeague.total_rosters} teams ‚Ä¢ ${transactions.length} trades`;
            
            const tradeCount = {};
            transactions.forEach(t => {
                if (t.adds) Object.values(t.adds).forEach(r => {
                    const owner = getOwner(r);
                    tradeCount[owner] = (tradeCount[owner] || 0) + 1;
                });
            });
            const mostActive = Object.entries(tradeCount).sort((a,b) => b[1]-a[1])[0];
            
            let biggestSize = 0;
            transactions.forEach(t => {
                const size = (t.adds ? Object.keys(t.adds).length : 0) + (t.draft_picks?.length || 0);
                if (size > biggestSize) biggestSize = size;
            });
            
            let picksCount = 0;
            transactions.forEach(t => { if (t.draft_picks) picksCount += t.draft_picks.length; });
            
            document.getElementById('statsSection').innerHTML = `
                <div class="bg-gradient-to-br from-red-900/40 to-orange-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-red-500/30">
                    <div class="text-red-300 text-sm font-semibold mb-1">Total Trades</div>
                    <div class="text-white text-3xl font-bold">${transactions.length}</div>
                </div>
                <div class="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-green-500/30">
                    <div class="text-green-300 text-sm font-semibold mb-1">Most Active</div>
                    <div class="text-white text-lg font-bold">${mostActive ? `${mostActive[0]} (${mostActive[1]})` : '-'}</div>
                </div>
                <div class="bg-gradient-to-br from-blue-900/40 to-cyan-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-blue-500/30">
                    <div class="text-blue-300 text-sm font-semibold mb-1">Biggest Trade</div>
                    <div class="text-white text-lg font-bold">${biggestSize} assets</div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/40 to-pink-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-purple-500/30">
                    <div class="text-purple-300 text-sm font-semibold mb-1">Picks Traded</div>
                    <div class="text-white text-3xl font-bold">${picksCount}</div>
                </div>
            `;
            
            document.getElementById('tabsSection').innerHTML = `
                <button id="tradesTab" class="flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm">ü§ù Trades</button>
                <button id="shameTab" class="flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm">üò± Hall of Shame</button>
            `;
            
            document.getElementById('tradesTab').addEventListener('click', showTrades);
            document.getElementById('shameTab').addEventListener('click', showShame);
            document.getElementById('exportTextBtn').addEventListener('click', exportText);
            document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
            
            // Username filter
            document.getElementById('usernameFilter').addEventListener('input', (e) => {
                currentFilter = e.target.value.trim().toLowerCase();
                updateFilterStatus();
                // Refresh current view
                if (document.getElementById('tradesTab').className.includes('from-red-600')) {
                    showTrades();
                } else {
                    showShame();
                }
            });
            
            document.getElementById('clearFilterBtn').addEventListener('click', () => {
                currentFilter = '';
                document.getElementById('usernameFilter').value = '';
                updateFilterStatus();
                // Refresh current view
                if (document.getElementById('tradesTab').className.includes('from-red-600')) {
                    showTrades();
                } else {
                    showShame();
                }
            });
            
            showTrades();
        }
        
        function updateFilterStatus() {
            const status = document.getElementById('filterStatus');
            if (currentFilter) {
                status.textContent = `Filtering trades involving: "${currentFilter}"`;
                status.classList.remove('hidden');
            } else {
                status.classList.add('hidden');
            }
        }
        
        function tradeInvolvesUser(trade) {
            if (!currentFilter) return true;
            
            const rosters = new Set();
            if (trade.adds) Object.values(trade.adds).forEach(r => rosters.add(r));
            
            for (const rosterId of rosters) {
                const owner = getOwner(rosterId).toLowerCase();
                if (owner.includes(currentFilter)) {
                    return true;
                }
            }
            
            return false;
        }

        function getOwner(rId) { return leagueUsers[rId]?.username || `Team ${rId}`; }
        function getPlayer(pId) { const p = players[pId]; return p ? `${p.first_name} ${p.last_name}` : 'Unknown'; }
        
        function getPlayerValue(pId) {
            const player = players[pId];
            if (!player) {
                return 0;
            }
            
            // Normalize names for better matching
            const normalizeName = (name) => {
                return name.toLowerCase()
                    .replace(/\./g, '') // Remove periods (J.J. -> JJ)
                    .replace(/'/g, '')  // Remove apostrophes (D'Andre -> DAndre)
                    .replace(/-/g, ' ') // Replace hyphens with spaces
                    .replace(/\s+/g, ' ') // Normalize spaces
                    .trim();
            };
            
            // Try various name formats
            const firstName = player.first_name || '';
            const lastName = player.last_name || '';
            const fullName = player.full_name || `${firstName} ${lastName}`;
            
            const namesToTry = [
                normalizeName(fullName),
                normalizeName(`${firstName} ${lastName}`),
                normalizeName(`${lastName}, ${firstName}`),
                normalizeName(lastName),
                // Handle Jr/Sr/III suffixes
                normalizeName(fullName.replace(/\s+(jr|sr|ii|iii|iv)\.?$/i, '')),
            ];
            
            // Remove duplicates
            const uniqueNames = [...new Set(namesToTry)];
            
            for (const name of uniqueNames) {
                if (name && dpValues[name]) {
                    return dpValues[name];
                }
            }
            
            // If still not found, log for debugging (only first time)
            if (!player._loggedMissing) {
                console.log('‚ùå No value for:', fullName, 'Tried:', uniqueNames);
                player._loggedMissing = true;
            }
            
            return 0;
        }
        
        function calcScore(trade) {
            const rosters = new Set();
            if (trade.adds) Object.values(trade.adds).forEach(r => rosters.add(r));
            const arr = Array.from(rosters);
            
            // Calculate actual trade values using DP values
            const values = arr.map(r => {
                let totalValue = 0;
                
                // Add player values
                if (trade.adds) {
                    Object.keys(trade.adds).forEach(pid => {
                        if (trade.adds[pid] === r) {
                            totalValue += getPlayerValue(pid);
                        }
                    });
                }
                
                // Add draft pick values (rough estimates)
                if (trade.draft_picks) {
                    trade.draft_picks.forEach(pick => {
                        if (pick.roster_id === r) {
                            // Estimate pick values: 1st round = 3000, 2nd = 1500, 3rd+ = 500
                            const pickValue = pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500;
                            totalValue += pickValue;
                        }
                    });
                }
                
                return totalValue;
            });
            
            if (values.length === 2) {
                const diff = Math.abs(values[0] - values[1]);
                const total = values[0] + values[1];
                if (total === 0) return 0;
                // Score based on percentage difference
                const pctDiff = (diff / total) * 100;
                return Math.min(100, Math.round(pctDiff * 2)); // Scale to 0-100
            }
            return 0;
        }
        
        function getRating(score) {
            if (score >= 70) return { level: 'COMPLETE FLEECE', sheep: 'üêëüêëüêëüêëüêë', color: 'fleece-badge', border: 'border-red-500' };
            if (score >= 50) return { level: 'MAJOR FLEECE', sheep: 'üêëüêëüêëüêë', color: 'bg-red-600', border: 'border-red-400' };
            if (score >= 30) return { level: 'QUESTIONABLE', sheep: 'üêëüêëüêë', color: 'questionable-badge', border: 'border-yellow-400' };
            if (score >= 15) return { level: 'SLIGHTLY UNEVEN', sheep: 'üêëüêë', color: 'bg-yellow-600', border: 'border-yellow-500' };
            return { level: 'FAIR TRADE', sheep: '‚úÖ', color: 'fair-badge', border: 'border-green-400' };
        }

        function showTrades() {
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            const filteredTransactions = transactions.filter(tradeInvolvesUser);
            
            const html = filteredTransactions.map((t, tradeIdx) => {
                const score = calcScore(t);
                const rating = getRating(score);
                
                // Get rosters involved in trade
                const rostersInvolved = new Set();
                
                // Primary method: use roster_ids if available (most accurate)
                if (t.roster_ids && t.roster_ids.length > 0) {
                    t.roster_ids.forEach(r => rostersInvolved.add(r));
                } else {
                    // Fallback: infer from adds
                    if (t.adds) Object.values(t.adds).forEach(r => rostersInvolved.add(r));
                }
                
                const rosterArray = Array.from(rostersInvolved);
                
                // Build complete trade view - GIVES and RECEIVES
                const rosterTrades = {};
                
                rosterArray.forEach(rosterId => {
                    rosterTrades[rosterId] = {
                        playersReceived: [],
                        playersGiven: [],
                        picksReceived: [],
                        picksGiven: []
                    };
                });
                
                // Map players RECEIVED (adds shows who gets what)
                if (t.adds) {
                    Object.keys(t.adds).forEach(playerId => {
                        const receivingRoster = t.adds[playerId];
                        if (rosterTrades[receivingRoster]) {
                            rosterTrades[receivingRoster].playersReceived.push(playerId);
                        }
                    });
                }
                
                // Map players GIVEN (drops shows who gave what)
                if (t.drops) {
                    Object.keys(t.drops).forEach(playerId => {
                        const givingRoster = t.drops[playerId];
                        if (rosterTrades[givingRoster]) {
                            rosterTrades[givingRoster].playersGiven.push(playerId);
                        }
                    });
                }
                
                // Map draft picks
                if (t.draft_picks) {
                    t.draft_picks.forEach(pick => {
                        // Who receives the pick
                        if (pick.roster_id && rosterTrades[pick.roster_id]) {
                            rosterTrades[pick.roster_id].picksReceived.push(pick);
                        }
                        
                        // Who gave up the pick
                        if (pick.previous_owner_id && rosterTrades[pick.previous_owner_id]) {
                            rosterTrades[pick.previous_owner_id].picksGiven.push(pick);
                        }
                    });
                }
                
                const tradeSides = rosterArray.map(rosterId => {
                    const trade = rosterTrades[rosterId];
                    const playersReceived = trade.playersReceived;
                    const playersGiven = trade.playersGiven;
                    const picksReceived = trade.picksReceived;
                    const picksGiven = trade.picksGiven;
                    
                    // Calculate values
                    let giveValue = 0;
                    playersGiven.forEach(pid => giveValue += getPlayerValue(pid));
                    picksGiven.forEach(pick => giveValue += pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500);
                    
                    let receiveValue = 0;
                    playersReceived.forEach(pid => receiveValue += getPlayerValue(pid));
                    picksReceived.forEach(pick => receiveValue += pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500);
                    
                    // Skip if nothing happened for this team
                    if (playersGiven.length === 0 && picksGiven.length === 0 && playersReceived.length === 0 && picksReceived.length === 0) {
                        return '';
                    }
                    
                    return `
                        <div class="bg-slate-900/60 p-5 rounded-xl border-2 border-orange-400/30">
                            <h3 class="text-xl font-bold text-white mb-4 headline border-b-2 border-orange-400/30 pb-2">
                                ${getOwner(rosterId)}
                            </h3>
                            
                            <!-- GIVES Section -->
                            ${(playersGiven.length > 0 || picksGiven.length > 0) ? `
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-red-400 font-bold text-sm headline">‚ùå GIVES AWAY:</h4>
                                        <span class="text-red-400 font-bold text-sm">${giveValue.toLocaleString()} pts</span>
                                    </div>
                                    <div class="space-y-1">
                                        ${playersGiven.map(p => {
                                            const val = getPlayerValue(p);
                                            return `<div class="text-gray-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${getPlayer(p)}</span>
                                                <span class="text-red-400">${val > 0 ? val.toLocaleString() : 'N/A'}</span>
                                            </div>`;
                                        }).join('')}
                                        ${picksGiven.map(p => {
                                            const val = p.round === 1 ? 3000 : p.round === 2 ? 1500 : 500;
                                            return `<div class="text-yellow-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${p.season} R${p.round} Pick</span>
                                                <span class="text-red-400">${val}</span>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- RECEIVES Section -->
                            ${(playersReceived.length > 0 || picksReceived.length > 0) ? `
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-green-400 font-bold text-sm headline">‚úÖ RECEIVES:</h4>
                                        <span class="text-green-400 font-bold text-sm">${receiveValue.toLocaleString()} pts</span>
                                    </div>
                                    <div class="space-y-1">
                                        ${playersReceived.map(p => {
                                            const val = getPlayerValue(p);
                                            return `<div class="text-gray-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${getPlayer(p)}</span>
                                                <span class="text-green-400">${val > 0 ? val.toLocaleString() : 'N/A'}</span>
                                            </div>`;
                                        }).join('')}
                                        ${picksReceived.map(p => {
                                            const val = p.round === 1 ? 3000 : p.round === 2 ? 1500 : 500;
                                            return `<div class="text-yellow-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${p.season} R${p.round} Pick</span>
                                                <span class="text-green-400">${val}</span>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Net Value -->
                            <div class="mt-3 pt-3 border-t border-orange-400/30">
                                <div class="flex justify-between items-center">
                                    <span class="text-purple-300 font-bold text-sm">NET VALUE:</span>
                                    <span class="text-purple-400 font-bold">${(receiveValue - giveValue).toLocaleString()} pts</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(s => s).join('');
                
                if (rosterArray.length < 2) return '';
                
                return `<div class="bg-red-900/30 rounded-2xl p-6 mb-4 border-2 ${rating.border} shadow-xl">
                    <div class="flex justify-between mb-4">
                        <div class="${rating.color} px-4 py-2 rounded-lg text-white font-bold border-2 ${rating.border}">${rating.sheep} ${rating.level}</div>
                        <div class="text-red-300 text-sm text-right">
                            <div>Fleece Score: <span class="font-bold text-lg">${score}/100</span></div>
                            <div class="text-xs">Week ${t.leg || 'N/A'} ‚Ä¢ ${new Date(t.created).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-${Math.min(rosterArray.length, 3)} gap-4">${tradeSides}</div>
                </div>`;
            }).filter(h => h).join('');
            
            if (!html) {
                const noTradesMsg = currentFilter 
                    ? `<div class="text-center text-red-200 p-12 headline">NO TRADES FOUND FOR "${currentFilter}"</div>`
                    : '<div class="text-center text-red-200 p-12 headline">NO TRADES FOUND</div>';
                document.getElementById('contentArea').innerHTML = noTradesMsg;
            } else {
                document.getElementById('contentArea').innerHTML = html;
            }
        }

        function showShame() {
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            const filteredTransactions = transactions.filter(tradeInvolvesUser);
            
            const sorted = filteredTransactions.map(t => ({ trade: t, score: calcScore(t), rating: getRating(calcScore(t)) }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 3); // TOP 3 ONLY
            
            if (sorted.length === 0 || sorted[0].score < 15) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-red-900/30 rounded-2xl p-12 text-center border-2 border-green-500/30">
                        <div class="text-8xl mb-4">üòá</div>
                        <h2 class="text-4xl font-black text-white mb-2 headline">NO MAJOR FLEECES DETECTED!</h2>
                        <p class="text-green-200 text-lg">All trades appear relatively fair. Good job, league!</p>
                    </div>
                `;
                return;
            }
            
            const html = sorted.map((item, idx) => {
                const t = item.trade;
                const rosters = new Set();
                if (t.adds) Object.values(t.adds).forEach(r => rosters.add(r));
                const rosterArray = Array.from(rosters);
                
                // Calculate who won (got more value)
                const teamValues = rosterArray.map(r => {
                    let value = 0;
                    if (t.adds) {
                        Object.keys(t.adds).forEach(pid => {
                            if (t.adds[pid] === r) value += getPlayerValue(pid);
                        });
                    }
                    if (t.draft_picks) {
                        t.draft_picks.forEach(pick => {
                            if (pick.roster_id === r) {
                                value += pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500;
                            }
                        });
                    }
                    return { rosterId: r, value: value };
                });
                
                const winner = teamValues.sort((a, b) => b.value - a.value)[0];
                const loser = teamValues[teamValues.length - 1];
                
                const medals = ['ü•á WORST', 'ü•à 2ND WORST', 'ü•â 3RD WORST'];
                
                // Get player details
                const sides = rosterArray.map(r => {
                    const pIds = t.adds ? Object.keys(t.adds).filter(p => t.adds[p] === r) : [];
                    const picks = t.draft_picks ? t.draft_picks.filter(p => p.roster_id === r) : [];
                    const isWinner = r === winner.rosterId;
                    
                    return `<div class="bg-slate-900/60 p-4 rounded-xl border-2 ${isWinner ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-white font-bold headline">${isWinner ? 'üëë WINNER' : 'üò≠ LOSER'}</h4>
                            <span class="${isWinner ? 'text-green-400' : 'text-red-400'} font-bold">${isWinner ? winner.value : loser.value} pts</span>
                        </div>
                        <h5 class="text-lg text-white mb-2">${getOwner(r)}</h5>
                        ${pIds.map(p => {
                            const val = getPlayerValue(p);
                            return `<div class="text-gray-300 text-sm flex justify-between">
                                <span>‚Ä¢ ${getPlayer(p)}</span>
                                <span class="text-purple-400">${val}</span>
                            </div>`;
                        }).join('')}
                        ${picks.map(p => {
                            const val = p.round === 1 ? 3000 : p.round === 2 ? 1500 : 500;
                            const originalOwner = getOwner(p.owner_id);
                            const pickLabel = p.owner_id === r ? 
                                `${p.season} R${p.round} Pick` : 
                                `${p.season} R${p.round} Pick (${originalOwner}'s)`;
                            return `<div class="text-yellow-300 text-sm flex justify-between">
                                <span>‚Ä¢ ${pickLabel}</span>
                                <span class="text-purple-400">${val}</span>
                            </div>`;
                        }).join('')}
                    </div>`;
                }).join('');
                
                return `<div class="bg-red-900/40 rounded-2xl p-6 mb-6 border-2 ${item.rating.border} shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-3xl font-black text-white mb-2 headline">${medals[idx]} FLEECE</div>
                            <div class="text-red-300 text-sm">Week ${t.leg || 'N/A'} ‚Ä¢ ${new Date(t.created).toLocaleDateString()}</div>
                        </div>
                        <div class="${item.rating.color} px-6 py-3 rounded-lg text-white font-bold text-center border-2 ${item.rating.border}">
                            <div class="text-3xl sheep-animation">${item.rating.sheep}</div>
                            <div class="text-sm mt-1">${item.score}/100</div>
                        </div>
                    </div>
                    <div class="bg-slate-900/30 p-4 rounded-xl mb-4">
                        <div class="text-yellow-400 text-sm font-bold mb-2">üí∞ VALUE DIFFERENCE</div>
                        <div class="text-white text-2xl font-bold">${Math.abs(winner.value - loser.value).toLocaleString()} points</div>
                        <div class="text-gray-400 text-xs">Based on DynastyProcess 2QB values</div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">${sides}</div>
                </div>`;
            }).join('');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-red-900/30 rounded-2xl p-8 border-2 border-red-500/30">
                    <div class="text-center mb-8">
                        <div class="text-9xl mb-4 sheep-animation">üêë</div>
                        <h2 class="text-5xl font-black text-white mb-2 headline">HALL OF SHAME</h2>
                        <p class="text-red-200 text-lg">The Top 3 Worst Trades of All Time</p>
                        <p class="text-red-300 text-sm mt-2">‚ö†Ô∏è Scored using DynastyProcess 2QB Dynasty Values ‚ö†Ô∏è</p>
                    </div>
                    ${html}
                    <div class="mt-6 p-4 bg-blue-900/20 rounded-xl border border-blue-500/30 text-center">
                        <p class="text-blue-200 text-sm">
                            üí° <strong>Note:</strong> Fleece scores use DynastyProcess 2QB/Superflex dynasty values. 
                            Trade context, team needs, and timing matter - take these ratings as entertainment!
                        </p>
                    </div>
                </div>
            `;
        }

        function exportText() {
            const report = `FLEECE FACTORY - ${currentLeague.name}\nTotal Trades: ${transactions.length}\n\n` +
                transactions.map((t, i) => `Trade #${i+1} - Week ${t.leg || 'N/A'} - Score: ${calcScore(t)}/100`).join('\n');
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FleeceFactory_Report.txt';
            a.click();
        }

        function exportCsv() {
            const csv = 'Trade,Week,Score\n' + transactions.map((t, i) => `${i+1},${t.leg || 'N/A'},${calcScore(t)}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FleeceFactory_Trades.csv';
            a.click();
        }

        function showError(msg) {
            document.getElementById('errorMsg').textContent = '‚ùå ' + msg;
            document.getElementById('errorMsg').classList.remove('hidden');
        }
        function hideError() { document.getElementById('errorMsg').classList.add('hidden'); }
        function showLoading() { document.getElementById('loadingMsg').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingMsg').classList.add('hidden'); }
    </script>
</body>
</html>