<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QK9Q4GNP7K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QK9Q4GNP7K');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleece Factory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #7c2d12 30%, #991b1b 70%, #0f172a 100%);
            min-height: 100vh;
            font-family: 'Oswald', sans-serif;
        }
        h1, h2, h3, .headline { font-family: 'Anton', sans-serif; letter-spacing: 2px; }
        .sheep-animation { display: inline-block; animation: sheep-jump 1s ease-in-out; }
        @keyframes sheep-jump {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-40px) rotate(0deg); }
        }
        .fleece-badge { background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%); }
        .fair-badge { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); }
        .questionable-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%); }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-6xl font-black text-white mb-2">
                <span class="bg-gradient-to-r from-red-500 via-orange-500 to-red-500 bg-clip-text text-transparent">FLEECE FACTORY</span>
            </h1>
            <p class="text-red-200 text-xl font-semibold">Exposing Dynasty League Robberies Since 2025</p>
        </div>

        <div id="inputSection" class="bg-gradient-to-br from-red-900/20 to-orange-900/20 backdrop-blur-md rounded-2xl p-8 mb-6 border-2 border-red-500/30">
            <div class="text-center mb-6">
                <div class="text-9xl mb-4 sheep-animation">üêë</div>
                <p class="text-red-200 text-lg font-semibold">Find out who got fleeced in your league!</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-red-200 text-sm font-semibold mb-3">Search by League ID</label>
                <div class="flex gap-3">
                    <input type="text" id="leagueId" placeholder="1181730976707772416" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white/10 border-2 border-red-400/30 text-white placeholder-red-300/50 focus:outline-none focus:border-red-400">
                    <button id="loadBtn" class="px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-lg font-semibold shadow-lg">
                        üèà Load League
                    </button>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <span class="text-red-300 text-sm">‚Äî OR ‚Äî</span>
            </div>
            
            <div>
                <label class="block text-red-200 text-sm font-semibold mb-3">Search by Username</label>
                <div class="flex gap-3">
                    <input type="text" id="usernameSearch" placeholder="Enter Sleeper username" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white/10 border-2 border-red-400/30 text-white placeholder-red-300/50 focus:outline-none focus:border-red-400">
                    <button id="searchUserBtn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-semibold shadow-lg">
                        üë§ Find User
                    </button>
                </div>
                <div id="userLeaguesSection" class="mt-4 hidden">
                    <label class="block text-red-200 text-sm font-semibold mb-2">Select a League:</label>
                    <div id="userLeaguesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            
            <div id="errorMsg" class="mt-4 text-red-400 text-sm hidden"></div>
            <div id="loadingMsg" class="mt-4 text-red-300 text-sm hidden">Loading...</div>
        </div>

        <div id="mainContent" class="hidden space-y-6">
            <div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
            
            <div class="bg-gradient-to-br from-red-900/30 to-orange-900/30 backdrop-blur-md rounded-2xl p-6 border-2 border-red-500/30">
                <h2 id="leagueName" class="text-3xl font-bold text-white"></h2>
                <p id="leagueInfo" class="text-red-300 mt-1"></p>
            </div>

            <div class="bg-gradient-to-br from-red-900/20 to-orange-900/20 backdrop-blur-md rounded-2xl p-2 border-2 border-red-500/30 flex flex-wrap gap-2" id="tabsSection"></div>

            <div id="filterSection" class="bg-gradient-to-br from-purple-900/20 to-pink-900/20 backdrop-blur-md rounded-2xl p-4 border-2 border-purple-500/30">
                <div class="flex items-center gap-3 flex-wrap">
                    <span class="font-bold headline text-purple-200">FILTER TRADES:</span>
                    <input type="text" id="usernameFilter" placeholder="Enter username to filter..." 
                        class="flex-1 min-w-[200px] px-4 py-2 rounded-lg bg-white/10 border-2 border-purple-400/30 text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400">
                    <button id="clearFilterBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-sm">
                        ‚úï Clear
                    </button>
                </div>
                <div id="filterStatus" class="mt-2 text-purple-300 text-sm hidden"></div>
            </div>

            <div class="bg-gradient-to-br from-red-900/20 to-orange-900/20 backdrop-blur-md rounded-2xl p-4 border-2 border-red-500/30 flex items-center justify-between">
                <span class="font-bold headline text-red-200">EXPORT REPORT</span>
                <div class="flex gap-2">
                    <button id="exportTextBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm">üìÑ Text</button>
                    <button id="exportCsvBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold text-sm">üìä CSV</button>
                </div>
            </div>

            <div id="contentArea"></div>
        </div>
    </div>

    <script>
        let players = {}, transactions = [], draftPicks = [], rosters = [], currentLeague = null, leagueUsers = {};
        let dpValues = {}; // DynastyProcess values
        let currentFilter = ''; // For username filtering

        // Load players and DP values
        fetch('https://api.sleeper.app/v1/players/nfl').then(r => r.json()).then(d => players = d);
        
        // Load DynastyProcess values via jsdelivr CDN (no CORS issues)
        fetch('https://cdn.jsdelivr.net/gh/dynastyprocess/data@master/files/values-players.csv')
            .then(r => r.text())
            .then(csv => {
                const lines = csv.trim().split('\n');
                const headerLine = lines[0];
                const headers = headerLine.split(',').map(h => h.trim());
                
                console.log('RAW HEADER LINE:', headerLine);
                console.log('PARSED HEADERS:', headers);
                
                // Find column indices - be flexible with header names
                let playerIdx = -1, value2qbIdx = -1, sleeperIdx = -1;
                headers.forEach((h, i) => {
                    const lower = h.toLowerCase();
                    console.log(`Column ${i}: "${h}" (lowercase: "${lower}")`);
                    
                    if (lower.includes('player') && !lower.includes('id')) playerIdx = i;
                    if (lower.includes('value') && lower.includes('2qb')) value2qbIdx = i;
                    if (lower.includes('sleeper') && lower.includes('id')) sleeperIdx = i;
                });
                
                console.log('FOUND Indices - player:', playerIdx, 'value_2qb:', value2qbIdx, 'sleeper_id:', sleeperIdx);
                
                if (playerIdx === -1 || value2qbIdx === -1) {
                    console.error('‚ùå Could not find required columns!');
                    console.log('Available columns:', headers);
                    alert('Error: CSV format not recognized. Check console for details.');
                    return;
                }
                
                // Parse each line
                let successCount = 0;
                let sleeperIdCount = 0;
                
                lines.slice(1).forEach((line, idx) => {
                    if (!line.trim()) return;
                    
                    const cols = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    
                    const playerName = cols[playerIdx];
                    const value = parseInt(cols[value2qbIdx]) || 0;
                    
                    if (value > 0 && playerName) {
                        // Normalize player name for better matching
                        const normalizedName = playerName.toLowerCase()
                            .replace(/\./g, '')
                            .replace(/'/g, '')
                            .replace(/-/g, ' ')
                            .replace(/\s+/g, ' ')
                            .replace(/\s+(jr|sr|ii|iii|iv)\.?$/i, '')
                            .trim();
                        
                        dpValues[normalizedName] = value;
                        successCount++;
                        
                        // Also store original name (lowercased)
                        dpValues[playerName.toLowerCase().trim()] = value;
                        
                        // Log specific players we're having trouble with
                        if (normalizedName.includes('mahomes') || normalizedName.includes('pittman') || 
                            normalizedName.includes('etienne') || normalizedName.includes('swift') ||
                            normalizedName.includes('robinson')) {
                            console.log(`Stored: "${playerName}" as "${normalizedName}" = ${value}`);
                        }
                    }
                });
                
                console.log('‚úÖ Loaded DP values:');
                console.log('  - By name:', successCount, 'players');
                console.log('  - By Sleeper ID:', sleeperIdCount, 'players');
                
                if (sleeperIdCount > 0) {
                    console.log('Sample entries:', Object.entries(dpValues).slice(0, 10));
                }
            })
            .catch(err => {
                console.error('‚ùå Error loading DP values:', err);
                alert('Warning: Could not load player values. Fleece scores will be estimates only.');
            });

        document.getElementById('loadBtn').addEventListener('click', async () => {
            const leagueId = document.getElementById('leagueId').value.trim();
            if (!leagueId) {
                showError('Please enter a league ID');
                return;
            }

            showLoading();
            hideError();

            try {
                const res = await fetch(`https://api.sleeper.app/v1/league/${leagueId}`);
                if (!res.ok) throw new Error('Not found');
                currentLeague = await res.json();
                
                document.getElementById('inputSection').classList.add('hidden');
                await loadData(leagueId);
                showContent();
            } catch (err) {
                showError('League not found');
            } finally {
                hideLoading();
            }
        });

        // Search by username
        document.getElementById('searchUserBtn').addEventListener('click', async () => {
            const username = document.getElementById('usernameSearch').value.trim();
            if (!username) {
                showError('Please enter a username');
                return;
            }

            showLoading();
            hideError();
            document.getElementById('userLeaguesSection').classList.add('hidden');

            try {
                // Get user info
                const userRes = await fetch(`https://api.sleeper.app/v1/user/${username}`);
                if (!userRes.ok) throw new Error('User not found');
                const user = await userRes.json();
                
                // Get user's leagues (2024 season)
                const leaguesRes = await fetch(`https://api.sleeper.app/v1/user/${user.user_id}/leagues/nfl/2024`);
                if (!leaguesRes.ok) throw new Error('Could not fetch leagues');
                const leagues = await leaguesRes.json();
                
                if (leagues.length === 0) {
                    showError('No leagues found for this user in 2024 season');
                    return;
                }
                
                // Display leagues
                const leaguesList = document.getElementById('userLeaguesList');
                leaguesList.innerHTML = leagues.map(league => `
                    <button class="w-full text-left px-4 py-3 bg-white/5 hover:bg-white/10 rounded-lg border border-red-400/30 text-white transition" 
                            onclick="loadLeagueById('${league.league_id}', '${league.name.replace(/'/g, "\\'")}')">
                        <div class="font-semibold">${league.name}</div>
                        <div class="text-sm text-red-300">${league.total_rosters} teams ‚Ä¢ ${league.settings.type === 2 ? 'Dynasty' : 'Redraft'}</div>
                    </button>
                `).join('');
                
                document.getElementById('userLeaguesSection').classList.remove('hidden');
                
            } catch (err) {
                showError(err.message || 'User not found');
            } finally {
                hideLoading();
            }
        });

        // Function to load league by ID (used by username search)
        async function loadLeagueById(leagueId, leagueName) {
            showLoading();
            hideError();
            
            try {
                const res = await fetch(`https://api.sleeper.app/v1/league/${leagueId}`);
                if (!res.ok) throw new Error('League not found');
                currentLeague = await res.json();
                
                document.getElementById('inputSection').classList.add('hidden');
                await loadData(leagueId);
                showContent();
            } catch (err) {
                showError('Error loading league');
            } finally {
                hideLoading();
            }
        }

        async function loadData(id) {
            const users = await fetch(`https://api.sleeper.app/v1/league/${id}/users`).then(r => r.json());
            rosters = await fetch(`https://api.sleeper.app/v1/league/${id}/rosters`).then(r => r.json());
            
            const userMap = {};
            users.forEach(u => userMap[u.user_id] = u);
            rosters.forEach(r => {
                const u = userMap[r.owner_id];
                leagueUsers[r.roster_id] = { username: u ? (u.display_name || u.username) : `Team ${r.roster_id}` };
            });

            transactions = [];
            for (let w = 1; w <= 18; w++) {
                try {
                    const data = await fetch(`https://api.sleeper.app/v1/league/${id}/transactions/${w}`).then(r => r.json());
                    if (data) transactions.push(...data);
                } catch {}
            }
            
            // Sort transactions by timestamp (oldest first) to process in chronological order
            transactions.sort((a, b) => a.created - b.created);
            
            // Track current ownership of players and picks throughout the season
            const playerOwnership = {}; // playerId -> rosterId
            const pickOwnership = {}; // "season-round-ownerId" -> rosterId
            
            // Initialize with current rosters
            rosters.forEach(roster => {
                if (roster.players) {
                    roster.players.forEach(playerId => {
                        playerOwnership[playerId] = roster.roster_id;
                    });
                }
                if (roster.draft_picks) {
                    roster.draft_picks.forEach(pick => {
                        const pickKey = `${pick.season}-${pick.round}-${pick.owner_id}`;
                        pickOwnership[pickKey] = roster.roster_id;
                    });
                }
            });
            
            // Filter to only trades
            transactions = transactions.filter(t => t.type === 'trade');
            
            // Process each trade to enrich with ownership info
            transactions.forEach(trade => {
                // For players being traded, determine who owned them before the trade
                if (trade.adds) {
                    const enhancedDrops = {};
                    Object.keys(trade.adds).forEach(playerId => {
                        const receivingRoster = trade.adds[playerId];
                        // Find who owned this player before (from our tracking or from drops)
                        const previousOwner = trade.drops?.[playerId] || playerOwnership[playerId];
                        if (previousOwner && previousOwner !== receivingRoster) {
                            enhancedDrops[playerId] = previousOwner;
                        }
                        // Update ownership tracking
                        playerOwnership[playerId] = receivingRoster;
                    });
                    
                    // Merge with existing drops data
                    trade.drops = { ...enhancedDrops, ...(trade.drops || {}) };
                }
                
                // For draft picks, the API already has previous_owner_id, but let's verify
                if (trade.draft_picks) {
                    trade.draft_picks.forEach(pick => {
                        const pickKey = `${pick.season}-${pick.round}-${pick.owner_id}`;
                        
                        // If previous_owner_id is missing, try to fill it from our tracking
                        if (!pick.previous_owner_id && pickOwnership[pickKey]) {
                            pick.previous_owner_id = pickOwnership[pickKey];
                        }
                        
                        // Update ownership tracking
                        pickOwnership[pickKey] = pick.roster_id;
                    });
                }
            });

            const drafts = await fetch(`https://api.sleeper.app/v1/league/${id}/drafts`).then(r => r.json());
            if (drafts?.[0]) {
                draftPicks = await fetch(`https://api.sleeper.app/v1/draft/${drafts[0].draft_id}/picks`).then(r => r.json()) || [];
            }
        }

        function showContent() {
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('leagueName').textContent = currentLeague.name;
            document.getElementById('leagueInfo').textContent = `${currentLeague.total_rosters} teams ‚Ä¢ ${transactions.length} trades`;
            
            const tradeCount = {};
            transactions.forEach(t => {
                if (t.adds) Object.values(t.adds).forEach(r => {
                    const owner = getOwner(r);
                    tradeCount[owner] = (tradeCount[owner] || 0) + 1;
                });
            });
            const mostActive = Object.entries(tradeCount).sort((a,b) => b[1]-a[1])[0];
            
            let biggestSize = 0;
            transactions.forEach(t => {
                const size = (t.adds ? Object.keys(t.adds).length : 0) + (t.draft_picks?.length || 0);
                if (size > biggestSize) biggestSize = size;
            });
            
            let picksCount = 0;
            transactions.forEach(t => { if (t.draft_picks) picksCount += t.draft_picks.length; });
            
            document.getElementById('statsSection').innerHTML = `
                <div class="bg-gradient-to-br from-red-900/40 to-orange-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-red-500/30">
                    <div class="text-red-300 text-sm font-semibold mb-1">Total Trades</div>
                    <div class="text-white text-3xl font-bold">${transactions.length}</div>
                </div>
                <div class="bg-gradient-to-br from-green-900/40 to-emerald-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-green-500/30">
                    <div class="text-green-300 text-sm font-semibold mb-1">Most Active</div>
                    <div class="text-white text-lg font-bold">${mostActive ? `${mostActive[0]} (${mostActive[1]})` : '-'}</div>
                </div>
                <div class="bg-gradient-to-br from-blue-900/40 to-cyan-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-blue-500/30">
                    <div class="text-blue-300 text-sm font-semibold mb-1">Biggest Trade</div>
                    <div class="text-white text-lg font-bold">${biggestSize} assets</div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/40 to-pink-900/40 backdrop-blur-md rounded-xl p-6 border-2 border-purple-500/30">
                    <div class="text-purple-300 text-sm font-semibold mb-1">Picks Traded</div>
                    <div class="text-white text-3xl font-bold">${picksCount}</div>
                </div>
            `;
            
            document.getElementById('tabsSection').innerHTML = `
                <button id="tradesTab" class="flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm">ü§ù Trades</button>
                <button id="shameTab" class="flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm">üò± Hall of Shame</button>
                <button id="whatIfTab" class="flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm">What If Trade Simulator ‚ùì</button>
                <button id="analyticsTab" class="flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm">üìä Analytics</button>
                <button id="powerRankingsTab" class="flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm">üìà Power Rankings</button>
            `;
            
            document.getElementById('tradesTab').addEventListener('click', showTrades);
            document.getElementById('shameTab').addEventListener('click', showShame);
            document.getElementById('whatIfTab').addEventListener('click', showWhatIf);
            document.getElementById('analyticsTab').addEventListener('click', showAnalytics);
            document.getElementById('powerRankingsTab').addEventListener('click', showPowerRankings);
            document.getElementById('exportTextBtn').addEventListener('click', exportText);
            document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
            
            // Username filter
            document.getElementById('usernameFilter').addEventListener('input', (e) => {
                currentFilter = e.target.value.trim().toLowerCase();
                updateFilterStatus();
                // Refresh current view
                const activeTab = document.querySelector('#tabsSection button.bg-gradient-to-r');
                if (activeTab.id === 'tradesTab') {
                    showTrades();
                } else if (activeTab.id === 'shameTab') {
                    showShame();
                }
            });
            
            document.getElementById('clearFilterBtn').addEventListener('click', () => {
                currentFilter = '';
                document.getElementById('usernameFilter').value = '';
                updateFilterStatus();
                // Refresh current view
                const activeTab = document.querySelector('#tabsSection button.bg-gradient-to-r');
                if (activeTab.id === 'tradesTab') {
                    showTrades();
                } else if (activeTab.id === 'shameTab') {
                    showShame();
                }
            });
            
            showTrades();
        }
        
        function updateFilterStatus() {
            const status = document.getElementById('filterStatus');
            if (currentFilter) {
                status.textContent = `Filtering trades involving: "${currentFilter}"`;
                status.classList.remove('hidden');
            } else {
                status.classList.add('hidden');
            }
        }
        
        function tradeInvolvesUser(trade) {
            if (!currentFilter) return true;
            
            const rosters = new Set();
            if (trade.adds) Object.values(trade.adds).forEach(r => rosters.add(r));
            
            for (const rosterId of rosters) {
                const owner = getOwner(rosterId).toLowerCase();
                if (owner.includes(currentFilter)) {
                    return true;
                }
            }
            
            return false;
        }

        function getOwner(rId) { return leagueUsers[rId]?.username || `Team ${rId}`; }
        function getPlayer(pId) { const p = players[pId]; return p ? `${p.first_name} ${p.last_name}` : 'Unknown'; }
        
        function getPlayerValue(pId) {
            const player = players[pId];
            if (!player) {
                return 0;
            }
            
            // Normalize names for better matching
            const normalizeName = (name) => {
                return name.toLowerCase()
                    .replace(/\./g, '') // Remove periods (J.J. -> JJ)
                    .replace(/'/g, '')  // Remove apostrophes (D'Andre -> DAndre)
                    .replace(/-/g, ' ') // Replace hyphens with spaces
                    .replace(/\s+/g, ' ') // Normalize spaces
                    .trim();
            };
            
            // Try various name formats
            const firstName = player.first_name || '';
            const lastName = player.last_name || '';
            const fullName = player.full_name || `${firstName} ${lastName}`;
            
            const namesToTry = [
                normalizeName(fullName),
                normalizeName(`${firstName} ${lastName}`),
                normalizeName(`${lastName}, ${firstName}`),
                normalizeName(lastName),
                // Handle Jr/Sr/III suffixes
                normalizeName(fullName.replace(/\s+(jr|sr|ii|iii|iv)\.?$/i, '')),
            ];
            
            // Remove duplicates
            const uniqueNames = [...new Set(namesToTry)];
            
            for (const name of uniqueNames) {
                if (name && dpValues[name]) {
                    return dpValues[name];
                }
            }
            
            // If still not found, log for debugging (only first time)
            if (!player._loggedMissing) {
                console.log('‚ùå No value for:', fullName, 'Tried:', uniqueNames);
                player._loggedMissing = true;
            }
            
            return 0;
        }
        
        function calcScore(trade) {
            const rosters = new Set();
            if (trade.adds) Object.values(trade.adds).forEach(r => rosters.add(r));
            const arr = Array.from(rosters);
            
            // Calculate actual trade values using DP values
            const values = arr.map(r => {
                let totalValue = 0;
                
                // Add player values
                if (trade.adds) {
                    Object.keys(trade.adds).forEach(pid => {
                        if (trade.adds[pid] === r) {
                            totalValue += getPlayerValue(pid);
                        }
                    });
                }
                
                // Add draft pick values (rough estimates)
                if (trade.draft_picks) {
                    trade.draft_picks.forEach(pick => {
                        if (pick.roster_id === r) {
                            // Estimate pick values: 1st round = 3000, 2nd = 1500, 3rd+ = 500
                            const pickValue = pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500;
                            totalValue += pickValue;
                        }
                    });
                }
                
                return totalValue;
            });
            
            if (values.length === 2) {
                const diff = Math.abs(values[0] - values[1]);
                const total = values[0] + values[1];
                if (total === 0) return 0;
                // Score based on percentage difference
                const pctDiff = (diff / total) * 100;
                return Math.min(100, Math.round(pctDiff * 2)); // Scale to 0-100
            }
            return 0;
        }
        
        function getRating(score) {
            if (score >= 70) return { level: 'COMPLETE FLEECE', sheep: 'üêëüêëüêëüêëüêë', color: 'fleece-badge', border: 'border-red-500' };
            if (score >= 50) return { level: 'MAJOR FLEECE', sheep: 'üêëüêëüêëüêë', color: 'bg-red-600', border: 'border-red-400' };
            if (score >= 30) return { level: 'QUESTIONABLE', sheep: 'üêëüêëüêë', color: 'questionable-badge', border: 'border-yellow-400' };
            if (score >= 15) return { level: 'SLIGHTLY UNEVEN', sheep: 'üêëüêë', color: 'bg-yellow-600', border: 'border-yellow-500' };
            return { level: 'FAIR TRADE', sheep: '‚úÖ', color: 'fair-badge', border: 'border-green-400' };
        }

        function showTrades() {
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            const filteredTransactions = transactions.filter(tradeInvolvesUser);
            
            const html = filteredTransactions.map((t, tradeIdx) => {
                const score = calcScore(t);
                const rating = getRating(score);
                
                // Debug: Log draft pick info for trades with picks
                if (t.draft_picks && t.draft_picks.length > 0) {
                    console.log('=== TRADE WITH PICKS ===');
                    console.log('Trade ID:', t.transaction_id);
                    console.log('Week:', t.leg);
                    console.log('Roster IDs in trade:', t.roster_ids, '‚Üí', t.roster_ids?.map(r => getOwner(r)));
                    console.log('Draft Picks:', t.draft_picks.map(p => ({
                        season: p.season,
                        round: p.round,
                        'goes to': `${p.roster_id} (${getOwner(p.roster_id)})`,
                        'originally': `${p.owner_id} (${getOwner(p.owner_id)})'s pick`,
                        'came from': p.previous_owner_id ? `${p.previous_owner_id} (${getOwner(p.previous_owner_id)})` : 'N/A'
                    })));
                    
                    if (t.adds) {
                        console.log('Players being added:');
                        Object.keys(t.adds).forEach(playerId => {
                            console.log(`  ${getPlayer(playerId)} ‚Üí ${t.adds[playerId]} (${getOwner(t.adds[playerId])})`);
                        });
                    }
                    
                    if (t.drops) {
                        console.log('Players being dropped:');
                        Object.keys(t.drops).forEach(playerId => {
                            console.log(`  ${getPlayer(playerId)} from ${t.drops[playerId]} (${getOwner(t.drops[playerId])})`);
                        });
                    }
                    console.log('========================\n');
                }
                
                // Get rosters involved in trade
                const rostersInvolved = new Set();
                
                // Primary method: use roster_ids if available (most accurate)
                if (t.roster_ids && t.roster_ids.length > 0) {
                    t.roster_ids.forEach(r => rostersInvolved.add(r));
                } else {
                    // Fallback: infer from adds and drops
                    if (t.adds) Object.values(t.adds).forEach(r => rostersInvolved.add(r));
                    if (t.drops) Object.values(t.drops).forEach(r => rostersInvolved.add(r));
                }
                
                // DO NOT add pick recipients/givers - roster_ids from API is correct
                // The owner_id in picks is just metadata about whose pick it originally was
                
                const rosterArray = Array.from(rostersInvolved);
                
                // Build complete trade view - GIVES and RECEIVES
                const rosterTrades = {};
                
                rosterArray.forEach(rosterId => {
                    rosterTrades[rosterId] = {
                        playersReceived: [],
                        playersGiven: [],
                        picksReceived: [],
                        picksGiven: []
                    };
                });
                
                console.log(`Trade ${t.transaction_id}: Rosters in this trade:`, rosterArray.map(r => `${r}=${getOwner(r)}`));
                
                rosterArray.forEach(rosterId => {
                    rosterTrades[rosterId] = {
                        playersReceived: [],
                        playersGiven: [],
                        picksReceived: [],
                        picksGiven: []
                    };
                });
                
                // Log the final roster trade breakdown for this specific trade (for debugging)
                if (t.draft_picks && t.draft_picks.length > 0 && t.transaction_id === '1245115986181365763') {
                    console.log('üîç DEBUGGING SPECIFIC TRADE:');
                    console.log('Rosters involved:', rosterArray.map(r => `${r} (${getOwner(r)})`));
                    console.log('Initial roster trades object:', JSON.parse(JSON.stringify(rosterTrades)));
                }
                
                // Map players RECEIVED (adds shows who gets what)
                if (t.adds) {
                    Object.keys(t.adds).forEach(playerId => {
                        const receivingRoster = t.adds[playerId];
                        if (rosterTrades[receivingRoster]) {
                            rosterTrades[receivingRoster].playersReceived.push(playerId);
                        }
                    });
                }
                
                // Map players GIVEN (drops shows who gave what - now enriched with ownership tracking)
                if (t.drops) {
                    Object.keys(t.drops).forEach(playerId => {
                        const givingRoster = t.drops[playerId];
                        if (rosterTrades[givingRoster]) {
                            rosterTrades[givingRoster].playersGiven.push(playerId);
                        }
                    });
                }
                
                // Map draft picks
                if (t.draft_picks) {
                    t.draft_picks.forEach(pick => {
                        console.log(`  üìå Processing pick: ${pick.season} R${pick.round}, roster_id=${pick.roster_id}, previous_owner_id=${pick.previous_owner_id}`);
                        console.log(`     Checking if roster ${pick.roster_id} is in rosterTrades:`, !!rosterTrades[pick.roster_id]);
                        console.log(`     Checking if roster ${pick.previous_owner_id} is in rosterTrades:`, !!rosterTrades[pick.previous_owner_id]);
                        
                        // Who receives the pick (roster_id is who gets it in THIS trade)
                        if (pick.roster_id) {
                            // The pick receiver should be in the trade's roster_ids
                            // If roster_id is in rosterTrades, add it to their received picks
                            if (rosterTrades[pick.roster_id]) {
                                rosterTrades[pick.roster_id].picksReceived.push(pick);
                                console.log(`     ‚úÖ Added to ${pick.roster_id} (${getOwner(pick.roster_id)}) RECEIVES`);
                            } else {
                                console.log(`     ‚ùå Roster ${pick.roster_id} NOT in trade participants!`);
                            }
                        }
                        
                        // Who gave up the pick - use previous_owner_id
                        if (pick.previous_owner_id) {
                            if (rosterTrades[pick.previous_owner_id]) {
                                rosterTrades[pick.previous_owner_id].picksGiven.push(pick);
                                console.log(`     ‚úÖ Added to ${pick.previous_owner_id} (${getOwner(pick.previous_owner_id)}) GIVES`);
                            } else {
                                console.log(`     ‚ùå Roster ${pick.previous_owner_id} NOT in trade participants!`);
                            }
                        }
                    });
                }
                
                const tradeSides = rosterArray.map(rosterId => {
                    const trade = rosterTrades[rosterId];
                    const playersReceived = trade.playersReceived;
                    const playersGiven = trade.playersGiven;
                    const picksReceived = trade.picksReceived;
                    const picksGiven = trade.picksGiven;
                    
                    // Calculate values
                    let giveValue = 0;
                    playersGiven.forEach(pid => giveValue += getPlayerValue(pid));
                    picksGiven.forEach(pick => giveValue += pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500);
                    
                    let receiveValue = 0;
                    playersReceived.forEach(pid => receiveValue += getPlayerValue(pid));
                    picksReceived.forEach(pick => receiveValue += pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500);
                    
                    // Skip if nothing happened for this team
                    if (playersGiven.length === 0 && picksGiven.length === 0 && playersReceived.length === 0 && picksReceived.length === 0) {
                        return '';
                    }
                    
                    return `
                        <div class="bg-slate-900/60 p-5 rounded-xl border-2 border-orange-400/30">
                            <h3 class="text-xl font-bold text-white mb-4 headline border-b-2 border-orange-400/30 pb-2">
                                ${getOwner(rosterId)}
                            </h3>
                            
                            <!-- GIVES Section -->
                            ${(playersGiven.length > 0 || picksGiven.length > 0) ? `
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-red-400 font-bold text-sm headline">‚ùå GIVES AWAY:</h4>
                                        <span class="text-red-400 font-bold text-sm">${giveValue.toLocaleString()} pts</span>
                                    </div>
                                    <div class="space-y-1">
                                        ${playersGiven.map(p => {
                                            const val = getPlayerValue(p);
                                            return `<div class="text-gray-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${getPlayer(p)}</span>
                                                <span class="text-red-400">${val > 0 ? val.toLocaleString() : 'N/A'}</span>
                                            </div>`;
                                        }).join('')}
                                        ${picksGiven.map(p => {
                                            const val = p.round === 1 ? 3000 : p.round === 2 ? 1500 : 500;
                                            const originalOwner = getOwner(p.owner_id);
                                            const pickLabel = p.owner_id === rosterId ? 
                                                `${p.season} R${p.round} Pick` : 
                                                `${p.season} R${p.round} Pick (${originalOwner}'s)`;
                                            return `<div class="text-yellow-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${pickLabel}</span>
                                                <span class="text-red-400">${val}</span>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-gray-400 font-bold text-sm headline">‚ùå GIVES AWAY:</h4>
                                        <span class="text-gray-400 font-bold text-sm">0 pts</span>
                                    </div>
                                    <div class="text-gray-500 text-sm italic pl-2">Nothing</div>
                                </div>
                            `}
                            
                            <!-- RECEIVES Section -->
                            ${(playersReceived.length > 0 || picksReceived.length > 0) ? `
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-green-400 font-bold text-sm headline">‚úÖ RECEIVES:</h4>
                                        <span class="text-green-400 font-bold text-sm">${receiveValue.toLocaleString()} pts</span>
                                    </div>
                                    <div class="space-y-1">
                                        ${playersReceived.map(p => {
                                            const val = getPlayerValue(p);
                                            return `<div class="text-gray-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${getPlayer(p)}</span>
                                                <span class="text-green-400">${val > 0 ? val.toLocaleString() : 'N/A'}</span>
                                            </div>`;
                                        }).join('')}
                                        ${picksReceived.map(p => {
                                            const val = p.round === 1 ? 3000 : p.round === 2 ? 1500 : 500;
                                            const originalOwner = getOwner(p.owner_id);
                                            const pickLabel = p.owner_id === p.roster_id ? 
                                                `${p.season} R${p.round} Pick` : 
                                                `${p.season} R${p.round} Pick (${originalOwner}'s)`;
                                            return `<div class="text-yellow-300 flex justify-between items-center text-sm pl-2">
                                                <span>‚Ä¢ ${pickLabel}</span>
                                                <span class="text-green-400">${val}</span>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-gray-400 font-bold text-sm headline">‚úÖ RECEIVES:</h4>
                                        <span class="text-gray-400 font-bold text-sm">0 pts</span>
                                    </div>
                                    <div class="text-gray-500 text-sm italic pl-2">Nothing</div>
                                </div>
                            `}
                            
                            <!-- Net Value -->
                            <div class="mt-3 pt-3 border-t border-orange-400/30">
                                <div class="flex justify-between items-center">
                                    <span class="text-purple-300 font-bold text-sm">NET VALUE:</span>
                                    <span class="text-purple-400 font-bold">${(receiveValue - giveValue).toLocaleString()} pts</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(s => s).join('');
                
                if (rosterArray.length < 2) return '';
                
                return `<div class="bg-red-900/30 rounded-2xl p-6 mb-4 border-2 ${rating.border} shadow-xl">
                    <div class="flex justify-between mb-4">
                        <div class="${rating.color} px-4 py-2 rounded-lg text-white font-bold border-2 ${rating.border}">${rating.sheep} ${rating.level}</div>
                        <div class="text-red-300 text-sm text-right">
                            <div>Fleece Score: <span class="font-bold text-lg">${score}/100</span></div>
                            <div class="text-xs">Week ${t.leg || 'N/A'} ‚Ä¢ ${new Date(t.created).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-${Math.min(rosterArray.length, 3)} gap-4">${tradeSides}</div>
                </div>`;
            }).filter(h => h).join('');
            
            if (!html) {
                const noTradesMsg = currentFilter 
                    ? `<div class="text-center text-red-200 p-12 headline">NO TRADES FOUND FOR "${currentFilter}"</div>`
                    : '<div class="text-center text-red-200 p-12 headline">NO TRADES FOUND</div>';
                document.getElementById('contentArea').innerHTML = noTradesMsg;
            } else {
                document.getElementById('contentArea').innerHTML = html;
            }
        }

        function showShame() {
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            const filteredTransactions = transactions.filter(tradeInvolvesUser);
            
            const sorted = filteredTransactions.map(t => ({ trade: t, score: calcScore(t), rating: getRating(calcScore(t)) }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 3); // TOP 3 ONLY
            
            if (sorted.length === 0 || sorted[0].score < 15) {
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-red-900/30 rounded-2xl p-12 text-center border-2 border-green-500/30">
                        <div class="text-8xl mb-4">üòá</div>
                        <h2 class="text-4xl font-black text-white mb-2 headline">NO MAJOR FLEECES DETECTED!</h2>
                        <p class="text-green-200 text-lg">All trades appear relatively fair. Good job, league!</p>
                    </div>
                `;
                return;
            }
            
            const html = sorted.map((item, idx) => {
                const t = item.trade;
                const rosters = new Set();
                if (t.adds) Object.values(t.adds).forEach(r => rosters.add(r));
                const rosterArray = Array.from(rosters);
                
                // Calculate who won (got more value)
                const teamValues = rosterArray.map(r => {
                    let value = 0;
                    if (t.adds) {
                        Object.keys(t.adds).forEach(pid => {
                            if (t.adds[pid] === r) value += getPlayerValue(pid);
                        });
                    }
                    if (t.draft_picks) {
                        t.draft_picks.forEach(pick => {
                            if (pick.roster_id === r) {
                                value += pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500;
                            }
                        });
                    }
                    return { rosterId: r, value: value };
                });
                
                const winner = teamValues.sort((a, b) => b.value - a.value)[0];
                const loser = teamValues[teamValues.length - 1];
                
                const medals = ['ü•á WORST', 'ü•à 2ND WORST', 'ü•â 3RD WORST'];
                
                // Get player details
                const sides = rosterArray.map(r => {
                    const pIds = t.adds ? Object.keys(t.adds).filter(p => t.adds[p] === r) : [];
                    const picks = t.draft_picks ? t.draft_picks.filter(p => p.roster_id === r) : [];
                    const isWinner = r === winner.rosterId;
                    
                    return `<div class="bg-slate-900/60 p-4 rounded-xl border-2 ${isWinner ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-white font-bold headline">${isWinner ? 'üëë WINNER' : 'üò≠ LOSER'}</h4>
                            <span class="${isWinner ? 'text-green-400' : 'text-red-400'} font-bold">${isWinner ? winner.value : loser.value} pts</span>
                        </div>
                        <h5 class="text-lg text-white mb-2">${getOwner(r)}</h5>
                        ${pIds.map(p => {
                            const val = getPlayerValue(p);
                            return `<div class="text-gray-300 text-sm flex justify-between">
                                <span>‚Ä¢ ${getPlayer(p)}</span>
                                <span class="text-purple-400">${val}</span>
                            </div>`;
                        }).join('')}
                        ${picks.map(p => {
                            const val = p.round === 1 ? 3000 : p.round === 2 ? 1500 : 500;
                            const originalOwner = getOwner(p.owner_id);
                            const pickLabel = p.owner_id === r ? 
                                `${p.season} R${p.round} Pick` : 
                                `${p.season} R${p.round} Pick (${originalOwner}'s)`;
                            return `<div class="text-yellow-300 text-sm flex justify-between">
                                <span>‚Ä¢ ${pickLabel}</span>
                                <span class="text-purple-400">${val}</span>
                            </div>`;
                        }).join('')}
                    </div>`;
                }).join('');
                
                return `<div class="bg-red-900/40 rounded-2xl p-6 mb-6 border-2 ${item.rating.border} shadow-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-3xl font-black text-white mb-2 headline">${medals[idx]} FLEECE</div>
                            <div class="text-red-300 text-sm">Week ${t.leg || 'N/A'} ‚Ä¢ ${new Date(t.created).toLocaleDateString()}</div>
                        </div>
                        <div class="${item.rating.color} px-6 py-3 rounded-lg text-white font-bold text-center border-2 ${item.rating.border}">
                            <div class="text-3xl sheep-animation">${item.rating.sheep}</div>
                            <div class="text-sm mt-1">${item.score}/100</div>
                        </div>
                    </div>
                    <div class="bg-slate-900/30 p-4 rounded-xl mb-4">
                        <div class="text-yellow-400 text-sm font-bold mb-2">üí∞ VALUE DIFFERENCE</div>
                        <div class="text-white text-2xl font-bold">${Math.abs(winner.value - loser.value).toLocaleString()} points</div>
                        <div class="text-gray-400 text-xs">Based on DynastyProcess 2QB values</div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">${sides}</div>
                </div>`;
            }).join('');
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-red-900/30 rounded-2xl p-8 border-2 border-red-500/30">
                    <div class="text-center mb-8">
                        <div class="text-9xl mb-4 sheep-animation">üêë</div>
                        <h2 class="text-5xl font-black text-white mb-2 headline">HALL OF SHAME</h2>
                        <p class="text-red-200 text-lg">The Top 3 Worst Trades of All Time</p>
                        <p class="text-red-300 text-sm mt-2">‚ö†Ô∏è Scored using DynastyProcess 2QB Dynasty Values ‚ö†Ô∏è</p>
                    </div>
                    ${html}
                    <div class="mt-6 p-4 bg-blue-900/20 rounded-xl border border-blue-500/30 text-center">
                        <p class="text-blue-200 text-sm">
                            üí° <strong>Note:</strong> Fleece scores use DynastyProcess 2QB/Superflex dynasty values. 
                            Trade context, team needs, and timing matter - take these ratings as entertainment!
                        </p>
                    </div>
                </div>
            `;
        }

        function showWhatIf() {
            document.getElementById('whatIfTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-red-900/30 rounded-2xl p-8 border-2 border-purple-500/30">
                    <div class="text-center mb-8">
                        <div class="text-7xl mb-4">‚ùì</div>
                        <h2 class="text-4xl font-black text-white mb-2 headline">WHAT IF TRADE SIMULATOR</h2>
                        <p class="text-purple-200 text-lg">Test potential trades before you make them!</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <!-- Team A Side -->
                        <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-blue-500/30">
                            <h3 class="text-2xl font-bold text-blue-400 mb-4 headline">TEAM A GIVES</h3>
                            
                            <div class="mb-4">
                                <label class="block text-blue-200 text-sm font-semibold mb-2">Search Players</label>
                                <input type="text" id="teamASearch" placeholder="Type player name..." 
                                    class="w-full px-4 py-2 rounded-lg bg-white/10 border-2 border-blue-400/30 text-white placeholder-blue-300/50 focus:outline-none focus:border-blue-400">
                                <div id="teamAResults" class="mt-2 max-h-40 overflow-y-auto space-y-1"></div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-blue-200 text-sm font-semibold mb-2">Add Draft Pick</label>
                                <div class="flex gap-2">
                                    <select id="teamAYear" class="px-3 py-2 rounded-lg bg-slate-800 border-2 border-blue-400/30 text-white focus:outline-none focus:border-blue-400">
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                    </select>
                                    <select id="teamARound" class="px-3 py-2 rounded-lg bg-slate-800 border-2 border-blue-400/30 text-white focus:outline-none focus:border-blue-400">
                                        <option value="1">1st (Early)</option>
                                        <option value="1-mid">1st (Mid)</option>
                                        <option value="1-late">1st (Late)</option>
                                        <option value="2">2nd (Early)</option>
                                        <option value="2-mid">2nd (Mid)</option>
                                        <option value="2-late">2nd (Late)</option>
                                        <option value="3">3rd</option>
                                        <option value="4">4th</option>
                                    </select>
                                    <button id="teamAAddPick" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm">+ Add</button>
                                </div>
                            </div>
                            
                            <div class="bg-black/30 rounded-lg p-4 min-h-[200px]">
                                <h4 class="text-blue-300 font-bold mb-2 text-sm">SELECTED ASSETS:</h4>
                                <div id="teamAAssets" class="space-y-2"></div>
                                <div class="mt-4 pt-4 border-t border-blue-400/30">
                                    <div class="flex justify-between items-center">
                                        <span class="text-blue-200 font-bold">TOTAL VALUE:</span>
                                        <span id="teamAValue" class="text-blue-400 font-bold text-xl">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Team B Side -->
                        <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-orange-500/30">
                            <h3 class="text-2xl font-bold text-orange-400 mb-4 headline">TEAM B GIVES</h3>
                            
                            <div class="mb-4">
                                <label class="block text-orange-200 text-sm font-semibold mb-2">Search Players</label>
                                <input type="text" id="teamBSearch" placeholder="Type player name..." 
                                    class="w-full px-4 py-2 rounded-lg bg-white/10 border-2 border-orange-400/30 text-white placeholder-orange-300/50 focus:outline-none focus:border-orange-400">
                                <div id="teamBResults" class="mt-2 max-h-40 overflow-y-auto space-y-1"></div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-orange-200 text-sm font-semibold mb-2">Add Draft Pick</label>
                                <div class="flex gap-2">
                                    <select id="teamBYear" class="px-3 py-2 rounded-lg bg-slate-800 border-2 border-orange-400/30 text-white focus:outline-none focus:border-orange-400">
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                    </select>
                                    <select id="teamBRound" class="px-3 py-2 rounded-lg bg-slate-800 border-2 border-orange-400/30 text-white focus:outline-none focus:border-orange-400">
                                        <option value="1">1st (Early)</option>
                                        <option value="1-mid">1st (Mid)</option>
                                        <option value="1-late">1st (Late)</option>
                                        <option value="2">2nd (Early)</option>
                                        <option value="2-mid">2nd (Mid)</option>
                                        <option value="2-late">2nd (Late)</option>
                                        <option value="3">3rd</option>
                                        <option value="4">4th</option>
                                    </select>
                                    <button id="teamBAddPick" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold text-sm">+ Add</button>
                                </div>
                            </div>
                            
                            <div class="bg-black/30 rounded-lg p-4 min-h-[200px]">
                                <h4 class="text-orange-300 font-bold mb-2 text-sm">SELECTED ASSETS:</h4>
                                <div id="teamBAssets" class="space-y-2"></div>
                                <div class="mt-4 pt-4 border-t border-orange-400/30">
                                    <div class="flex justify-between items-center">
                                        <span class="text-orange-200 font-bold">TOTAL VALUE:</span>
                                        <span id="teamBValue" class="text-orange-400 font-bold text-xl">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-6">
                        <button id="calculateTrade" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-bold text-lg shadow-xl">
                            üî• CALCULATE FLEECE RATING
                        </button>
                    </div>
                    
                    <div id="tradeResult" class="hidden"></div>
                </div>
            `;
            
            // Initialize What If functionality
            const teamAAssets = [];
            const teamBAssets = [];
            
            // Player search for Team A
            document.getElementById('teamASearch').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                const results = document.getElementById('teamAResults');
                
                if (query.length < 2) {
                    results.innerHTML = '';
                    return;
                }
                
                const matches = Object.values(players)
                    .filter(p => {
                        const fullName = `${p.first_name} ${p.last_name}`.toLowerCase();
                        return fullName.includes(query) && p.position && ['QB', 'RB', 'WR', 'TE'].includes(p.position);
                    })
                    .slice(0, 8);
                
                results.innerHTML = matches.map(p => {
                    const value = getPlayerValue(p.player_id);
                    return `<div class="bg-white/5 hover:bg-white/10 px-3 py-2 rounded cursor-pointer text-sm flex justify-between items-center" 
                                 onclick="addPlayerToTeam('A', '${p.player_id}', '${p.first_name} ${p.last_name}', ${value})">
                        <span class="text-white">${p.first_name} ${p.last_name} <span class="text-gray-400">(${p.position} - ${p.team || 'FA'})</span></span>
                        <span class="text-blue-400 font-bold">${value > 0 ? value.toLocaleString() : 'N/A'}</span>
                    </div>`;
                }).join('');
            });
            
            // Player search for Team B
            document.getElementById('teamBSearch').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                const results = document.getElementById('teamBResults');
                
                if (query.length < 2) {
                    results.innerHTML = '';
                    return;
                }
                
                const matches = Object.values(players)
                    .filter(p => {
                        const fullName = `${p.first_name} ${p.last_name}`.toLowerCase();
                        return fullName.includes(query) && p.position && ['QB', 'RB', 'WR', 'TE'].includes(p.position);
                    })
                    .slice(0, 8);
                
                results.innerHTML = matches.map(p => {
                    const value = getPlayerValue(p.player_id);
                    return `<div class="bg-white/5 hover:bg-white/10 px-3 py-2 rounded cursor-pointer text-sm flex justify-between items-center" 
                                 onclick="addPlayerToTeam('B', '${p.player_id}', '${p.first_name} ${p.last_name}', ${value})">
                        <span class="text-white">${p.first_name} ${p.last_name} <span class="text-gray-400">(${p.position} - ${p.team || 'FA'})</span></span>
                        <span class="text-orange-400 font-bold">${value > 0 ? value.toLocaleString() : 'N/A'}</span>
                    </div>`;
                }).join('');
            });
            
            // Add pick for Team A
            document.getElementById('teamAAddPick').addEventListener('click', () => {
                const year = document.getElementById('teamAYear').value;
                const round = document.getElementById('teamARound').value;
                
                // Enhanced pick valuation based on round and projected position
                let value, displayName;
                
                if (round === '1') {
                    value = 4500; // Early 1st (picks 1-4)
                    displayName = `${year} Early 1st`;
                } else if (round === '1-mid') {
                    value = 3500; // Mid 1st (picks 5-8)
                    displayName = `${year} Mid 1st`;
                } else if (round === '1-late') {
                    value = 2500; // Late 1st (picks 9-12)
                    displayName = `${year} Late 1st`;
                } else if (round === '2') {
                    value = 1800; // Early 2nd
                    displayName = `${year} Early 2nd`;
                } else if (round === '2-mid') {
                    value = 1400; // Mid 2nd
                    displayName = `${year} Mid 2nd`;
                } else if (round === '2-late') {
                    value = 1000; // Late 2nd
                    displayName = `${year} Late 2nd`;
                } else if (round === '3') {
                    value = 500;
                    displayName = `${year} 3rd Round`;
                } else {
                    value = 200;
                    displayName = `${year} 4th Round`;
                }
                
                // Future years discount slightly
                const yearNum = parseInt(year);
                if (yearNum > 2025) {
                    const yearsOut = yearNum - 2025;
                    value = Math.round(value * (1 - (yearsOut * 0.1))); // 10% discount per year
                }
                
                const id = `pick-a-${Date.now()}`;
                teamAAssets.push({ id, type: 'pick', name: displayName, value });
                updateTeamDisplay('A', teamAAssets);
            });
            
            // Add pick for Team B
            document.getElementById('teamBAddPick').addEventListener('click', () => {
                const year = document.getElementById('teamBYear').value;
                const round = document.getElementById('teamBRound').value;
                
                // Enhanced pick valuation based on round and projected position
                let value, displayName;
                
                if (round === '1') {
                    value = 4500; // Early 1st (picks 1-4)
                    displayName = `${year} Early 1st`;
                } else if (round === '1-mid') {
                    value = 3500; // Mid 1st (picks 5-8)
                    displayName = `${year} Mid 1st`;
                } else if (round === '1-late') {
                    value = 2500; // Late 1st (picks 9-12)
                    displayName = `${year} Late 1st`;
                } else if (round === '2') {
                    value = 1800; // Early 2nd
                    displayName = `${year} Early 2nd`;
                } else if (round === '2-mid') {
                    value = 1400; // Mid 2nd
                    displayName = `${year} Mid 2nd`;
                } else if (round === '2-late') {
                    value = 1000; // Late 2nd
                    displayName = `${year} Late 2nd`;
                } else if (round === '3') {
                    value = 500;
                    displayName = `${year} 3rd Round`;
                } else {
                    value = 200;
                    displayName = `${year} 4th Round`;
                }
                
                // Future years discount slightly
                const yearNum = parseInt(year);
                if (yearNum > 2025) {
                    const yearsOut = yearNum - 2025;
                    value = Math.round(value * (1 - (yearsOut * 0.1))); // 10% discount per year
                }
                
                const id = `pick-b-${Date.now()}`;
                teamBAssets.push({ id, type: 'pick', name: displayName, value });
                updateTeamDisplay('B', teamBAssets);
            });
            
            // Global functions for adding players
            window.addPlayerToTeam = (team, playerId, playerName, value) => {
                const assets = team === 'A' ? teamAAssets : teamBAssets;
                
                // Check if already added
                if (assets.find(a => a.id === playerId)) return;
                
                assets.push({ id: playerId, type: 'player', name: playerName, value });
                updateTeamDisplay(team, assets);
                
                // Clear search
                document.getElementById(`team${team}Search`).value = '';
                document.getElementById(`team${team}Results`).innerHTML = '';
            };
            
            window.removeAsset = (team, assetId) => {
                const assets = team === 'A' ? teamAAssets : teamBAssets;
                const index = assets.findIndex(a => a.id === assetId);
                if (index > -1) assets.splice(index, 1);
                updateTeamDisplay(team, assets);
            };
            
            function updateTeamDisplay(team, assets) {
                const container = document.getElementById(`team${team}Assets`);
                const valueDisplay = document.getElementById(`team${team}Value`);
                
                const totalValue = assets.reduce((sum, a) => sum + a.value, 0);
                
                container.innerHTML = assets.length > 0 ? assets.map(a => `
                    <div class="flex justify-between items-center bg-white/5 px-3 py-2 rounded">
                        <span class="text-white text-sm">${a.type === 'pick' ? 'üìÖ' : 'üë§'} ${a.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-${team === 'A' ? 'blue' : 'orange'}-400 font-bold text-sm">${a.value.toLocaleString()}</span>
                            <button onclick="removeAsset('${team}', '${a.id}')" class="text-red-400 hover:text-red-300 font-bold">‚úï</button>
                        </div>
                    </div>
                `).join('') : '<div class="text-gray-400 text-sm text-center py-4">No assets added yet</div>';
                
                valueDisplay.textContent = totalValue.toLocaleString();
            }
            
            // Calculate button
            document.getElementById('calculateTrade').addEventListener('click', () => {
                const teamATotal = teamAAssets.reduce((sum, a) => sum + a.value, 0);
                const teamBTotal = teamBAssets.reduce((sum, a) => sum + a.value, 0);
                
                if (teamAAssets.length === 0 || teamBAssets.length === 0) {
                    alert('Please add assets to both teams!');
                    return;
                }
                
                const diff = Math.abs(teamATotal - teamBTotal);
                const total = teamATotal + teamBTotal;
                const pctDiff = total > 0 ? (diff / total) * 100 : 0;
                const score = Math.min(100, Math.round(pctDiff * 2));
                const rating = getRating(score);
                
                const winner = teamATotal > teamBTotal ? 'A' : 'B';
                const loser = winner === 'A' ? 'B' : 'A';
                
                document.getElementById('tradeResult').innerHTML = `
                    <div class="bg-gradient-to-br from-purple-900/40 to-pink-900/40 rounded-xl p-8 border-2 ${rating.border}">
                        <div class="text-center mb-6">
                            <div class="${rating.color} inline-block px-8 py-4 rounded-xl border-2 ${rating.border} mb-4">
                                <div class="text-5xl mb-2">${rating.sheep}</div>
                                <div class="text-white font-bold text-2xl headline">${rating.level}</div>
                                <div class="text-white/80 text-lg mt-1">Fleece Score: ${score}/100</div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-slate-900/60 rounded-xl p-6 border-2 ${winner === 'A' ? 'border-green-500' : 'border-red-500'}">
                                <h4 class="text-2xl font-bold ${winner === 'A' ? 'text-green-400' : 'text-red-400'} mb-2 headline">
                                    ${winner === 'A' ? 'üëë TEAM A WINS' : 'üò≠ TEAM A LOSES'}
                                </h4>
                                <div class="text-white text-xl font-bold mb-4">${teamATotal.toLocaleString()} points</div>
                                <div class="space-y-1">
                                    ${teamAAssets.map(a => `
                                        <div class="text-gray-300 text-sm">‚Ä¢ ${a.name} (${a.value.toLocaleString()})</div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bg-slate-900/60 rounded-xl p-6 border-2 ${winner === 'B' ? 'border-green-500' : 'border-red-500'}">
                                <h4 class="text-2xl font-bold ${winner === 'B' ? 'text-green-400' : 'text-red-400'} mb-2 headline">
                                    ${winner === 'B' ? 'üëë TEAM B WINS' : 'üò≠ TEAM B LOSES'}
                                </h4>
                                <div class="text-white text-xl font-bold mb-4">${teamBTotal.toLocaleString()} points</div>
                                <div class="space-y-1">
                                    ${teamBAssets.map(a => `
                                        <div class="text-gray-300 text-sm">‚Ä¢ ${a.name} (${a.value.toLocaleString()})</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-900/20 rounded-lg p-4 border border-yellow-500/30 text-center">
                            <div class="text-yellow-400 font-bold text-lg mb-2">üí∞ VALUE DIFFERENCE</div>
                            <div class="text-white text-3xl font-bold">${diff.toLocaleString()} points</div>
                            <div class="text-yellow-300 text-sm mt-2">${pctDiff.toFixed(1)}% imbalance</div>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <p class="text-purple-200 text-sm">
                                üí° Values based on DynastyProcess 2QB rankings. Context matters - trust your gut!
                            </p>
                        </div>
                    </div>
                `;
                
                document.getElementById('tradeResult').classList.remove('hidden');
                document.getElementById('tradeResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });
        }

        function showAnalytics() {
            document.getElementById('analyticsTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            document.getElementById('whatIfTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            // Calculate analytics
            const analytics = calculateLeagueAnalytics();
            
            document.getElementById('contentArea').innerHTML = `
                <div class="space-y-6">
                    <!-- League Health Header -->
                    <div class="bg-gradient-to-br from-blue-900/30 to-cyan-900/30 rounded-2xl p-8 border-2 border-cyan-500/30">
                        <div class="text-center mb-6">
                            <div class="text-7xl mb-4">üìä</div>
                            <h2 class="text-4xl font-black text-white mb-2 headline">LEAGUE ANALYTICS</h2>
                            <p class="text-cyan-200 text-lg">Deep insights into your league's health and trading patterns</p>
                        </div>
                    </div>
                    
                    <!-- Competitive Balance Score -->
                    <div class="bg-gradient-to-br from-green-900/30 to-emerald-900/30 rounded-2xl p-6 border-2 border-green-500/30">
                        <h3 class="text-2xl font-bold text-white mb-4 headline flex items-center gap-2">
                            ‚öñÔ∏è COMPETITIVE BALANCE SCORE
                        </h3>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-green-400/30">
                                <div class="text-green-300 text-sm font-semibold mb-2">League Balance</div>
                                <div class="text-white text-4xl font-bold mb-2">${analytics.balance.score}/100</div>
                                <div class="text-green-200 text-sm">${analytics.balance.rating}</div>
                            </div>
                            <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-blue-400/30">
                                <div class="text-blue-300 text-sm font-semibold mb-2">Strongest Team</div>
                                <div class="text-white text-xl font-bold mb-1">${analytics.balance.strongest.name}</div>
                                <div class="text-blue-200 text-lg">${analytics.balance.strongest.value.toLocaleString()} pts</div>
                            </div>
                            <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-orange-400/30">
                                <div class="text-orange-300 text-sm font-semibold mb-2">Weakest Team</div>
                                <div class="text-white text-xl font-bold mb-1">${analytics.balance.weakest.name}</div>
                                <div class="text-orange-200 text-lg">${analytics.balance.weakest.value.toLocaleString()} pts</div>
                            </div>
                        </div>
                        <div class="mt-4 bg-black/30 rounded-lg p-4">
                            <div class="text-gray-300 text-sm">
                                <strong>Analysis:</strong> ${analytics.balance.analysis}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Impact Analysis -->
                    <div class="bg-gradient-to-br from-purple-900/30 to-pink-900/30 rounded-2xl p-6 border-2 border-purple-500/30">
                        <h3 class="text-2xl font-bold text-white mb-4 headline flex items-center gap-2">
                            üìà TRADE IMPACT ANALYSIS
                        </h3>
                        <div class="space-y-3">
                            ${analytics.tradeImpact.map(impact => `
                                <div class="bg-slate-900/60 rounded-xl p-4 border-2 ${impact.netGain > 0 ? 'border-green-500/30' : impact.netGain < 0 ? 'border-red-500/30' : 'border-gray-500/30'}">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-white font-bold text-lg">${impact.name}</h4>
                                        <div class="text-right">
                                            <div class="${impact.netGain > 0 ? 'text-green-400' : impact.netGain < 0 ? 'text-red-400' : 'text-gray-400'} font-bold text-xl">
                                                ${impact.netGain > 0 ? '+' : ''}${impact.netGain.toLocaleString()} pts
                                            </div>
                                            <div class="text-gray-400 text-xs">${impact.trades} trades</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div class="text-green-300">Gained: ${impact.gained.toLocaleString()}</div>
                                        <div class="text-red-300">Given: ${impact.given.toLocaleString()}</div>
                                    </div>
                                    <div class="mt-2 text-xs ${impact.netGain > 0 ? 'text-green-200' : impact.netGain < 0 ? 'text-red-200' : 'text-gray-300'}">
                                        ${impact.netGain > 0 ? 'üìà Net Winner' : impact.netGain < 0 ? 'üìâ Net Loser' : '‚ÜîÔ∏è Break Even'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Player Value Trends -->
                    <div class="bg-gradient-to-br from-yellow-900/30 to-orange-900/30 rounded-2xl p-6 border-2 border-yellow-500/30">
                        <h3 class="text-2xl font-bold text-white mb-4 headline flex items-center gap-2">
                            üìâ PLAYER VALUE TRENDS
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            ${analytics.playerTrends.mostTraded.length > 0 ? `
                                <div class="bg-slate-900/60 rounded-xl p-4 border-2 border-yellow-400/30">
                                    <h4 class="text-yellow-300 font-bold mb-3">üî• Most Traded Players</h4>
                                    <div class="space-y-2">
                                        ${analytics.playerTrends.mostTraded.map(p => `
                                            <div class="flex justify-between items-center text-sm">
                                                <span class="text-white">${p.name}</span>
                                                <span class="text-yellow-400 font-bold">${p.count}x traded</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${analytics.playerTrends.highValue.length > 0 ? `
                                <div class="bg-slate-900/60 rounded-xl p-4 border-2 border-green-400/30">
                                    <h4 class="text-green-300 font-bold mb-3">üíé Highest Value Traded</h4>
                                    <div class="space-y-2">
                                        ${analytics.playerTrends.highValue.map(p => `
                                            <div class="flex justify-between items-center text-sm">
                                                <span class="text-white">${p.name}</span>
                                                <span class="text-green-400 font-bold">${p.value.toLocaleString()} pts</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Buy Low/Sell High Alerts -->
                    <div class="bg-gradient-to-br from-red-900/30 to-orange-900/30 rounded-2xl p-6 border-2 border-red-500/30">
                        <h3 class="text-2xl font-bold text-white mb-4 headline flex items-center gap-2">
                            üö® BUY LOW / SELL HIGH ALERTS
                        </h3>
                        ${analytics.alerts.length > 0 ? `
                            <div class="space-y-3">
                                ${analytics.alerts.map(alert => `
                                    <div class="bg-slate-900/60 rounded-xl p-4 border-2 ${alert.type === 'buy' ? 'border-green-500/30' : 'border-orange-500/30'}">
                                        <div class="flex items-start gap-3">
                                            <div class="text-3xl">${alert.type === 'buy' ? 'üìâ' : 'üìà'}</div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="text-white font-bold text-lg">${alert.player}</h4>
                                                    <span class="${alert.type === 'buy' ? 'text-green-400' : 'text-orange-400'} font-bold text-sm px-3 py-1 rounded-full bg-black/30">
                                                        ${alert.type === 'buy' ? 'BUY LOW' : 'SELL HIGH'}
                                                    </span>
                                                </div>
                                                <div class="text-gray-300 text-sm mb-2">${alert.reason}</div>
                                                <div class="flex gap-4 text-xs">
                                                    <span class="text-blue-300">Market Value: ${alert.marketValue.toLocaleString()}</span>
                                                    <span class="${alert.type === 'buy' ? 'text-green-300' : 'text-orange-300'}">Recent Trade: ${alert.tradeValue.toLocaleString()}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-8 text-gray-400">
                                <div class="text-5xl mb-3">üò¥</div>
                                <p>No clear buy low or sell high opportunities detected yet.</p>
                                <p class="text-sm mt-2">More trades will reveal market inefficiencies!</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function calculateLeagueAnalytics() {
            // Calculate roster values for each team
            const teamValues = {};
            rosters.forEach(roster => {
                const teamName = getOwner(roster.roster_id);
                let totalValue = 0;
                
                if (roster.players) {
                    roster.players.forEach(playerId => {
                        totalValue += getPlayerValue(playerId);
                    });
                }
                
                teamValues[roster.roster_id] = {
                    name: teamName,
                    value: totalValue
                };
            });
            
            // Competitive Balance Score
            const values = Object.values(teamValues).map(t => t.value);
            const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - avgValue, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            const coefficientOfVariation = (stdDev / avgValue) * 100;
            
            // Balance score: lower variation = higher score (more balanced)
            const balanceScore = Math.max(0, Math.min(100, 100 - coefficientOfVariation));
            
            let balanceRating = '';
            if (balanceScore >= 80) balanceRating = 'üü¢ Highly Competitive - Very balanced league!';
            else if (balanceScore >= 60) balanceRating = 'üü° Moderately Balanced - Some disparity exists';
            else if (balanceScore >= 40) balanceRating = 'üü† Unbalanced - Clear top and bottom tiers';
            else balanceRating = 'üî¥ Highly Unbalanced - Major competitive issues';
            
            const sortedTeams = Object.values(teamValues).sort((a, b) => b.value - a.value);
            const strongest = sortedTeams[0];
            const weakest = sortedTeams[sortedTeams.length - 1];
            
            const analysis = `The gap between strongest and weakest team is ${(strongest.value - weakest.value).toLocaleString()} points. ${
                balanceScore >= 70 ? 'Your league is fairly competitive!' : 
                balanceScore >= 50 ? 'Some teams may need to rebuild or make moves.' :
                'Major roster imbalance - consider encouraging trades or addressing inactive teams.'
            }`;
            
            // Trade Impact Analysis
            const tradeImpact = {};
            rosters.forEach(roster => {
                const teamName = getOwner(roster.roster_id);
                tradeImpact[roster.roster_id] = {
                    name: teamName,
                    gained: 0,
                    given: 0,
                    trades: 0,
                    netGain: 0
                };
            });
            
            transactions.forEach(trade => {
                const rosters = new Set();
                if (trade.adds) Object.values(trade.adds).forEach(r => rosters.add(r));
                
                rosters.forEach(rosterId => {
                    if (!tradeImpact[rosterId]) return;
                    
                    tradeImpact[rosterId].trades++;
                    
                    // Calculate what they gained
                    if (trade.adds) {
                        Object.keys(trade.adds).forEach(playerId => {
                            if (trade.adds[playerId] === rosterId) {
                                tradeImpact[rosterId].gained += getPlayerValue(playerId);
                            }
                        });
                    }
                    
                    if (trade.draft_picks) {
                        trade.draft_picks.forEach(pick => {
                            if (pick.roster_id === rosterId) {
                                const pickValue = pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500;
                                tradeImpact[rosterId].gained += pickValue;
                            }
                        });
                    }
                    
                    // Calculate what they gave
                    if (trade.drops) {
                        Object.keys(trade.drops).forEach(playerId => {
                            if (trade.drops[playerId] === rosterId) {
                                tradeImpact[rosterId].given += getPlayerValue(playerId);
                            }
                        });
                    }
                    
                    if (trade.draft_picks) {
                        trade.draft_picks.forEach(pick => {
                            if (pick.previous_owner_id === rosterId) {
                                const pickValue = pick.round === 1 ? 3000 : pick.round === 2 ? 1500 : 500;
                                tradeImpact[rosterId].given += pickValue;
                            }
                        });
                    }
                });
            });
            
            Object.keys(tradeImpact).forEach(rosterId => {
                tradeImpact[rosterId].netGain = tradeImpact[rosterId].gained - tradeImpact[rosterId].given;
            });
            
            const impactArray = Object.values(tradeImpact)
                .filter(t => t.trades > 0)
                .sort((a, b) => b.netGain - a.netGain);
            
            // Player Trends
            const playerTradeCounts = {};
            const playerValues = {};
            
            transactions.forEach(trade => {
                if (trade.adds) {
                    Object.keys(trade.adds).forEach(playerId => {
                        const playerName = getPlayer(playerId);
                        playerTradeCounts[playerName] = (playerTradeCounts[playerName] || 0) + 1;
                        playerValues[playerName] = getPlayerValue(playerId);
                    });
                }
            });
            
            const mostTraded = Object.entries(playerTradeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, count]) => ({ name, count }));
            
            const highValue = Object.entries(playerValues)
                .filter(([name, value]) => value > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, value]) => ({ name, value }));
            
            // Buy Low/Sell High Alerts
            const alerts = [];
            const recentTrades = {};
            
            transactions.forEach(trade => {
                if (trade.adds) {
                    Object.keys(trade.adds).forEach(playerId => {
                        const playerName = getPlayer(playerId);
                        const marketValue = getPlayerValue(playerId);
                        
                        // Calculate what they were traded for
                        let tradeValue = 0;
                        const tradingTeam = trade.adds[playerId];
                        
                        if (trade.drops) {
                            Object.keys(trade.drops).forEach(pid => {
                                if (trade.drops[pid] !== tradingTeam) {
                                    tradeValue += getPlayerValue(pid);
                                }
                            });
                        }
                        
                        if (!recentTrades[playerName]) {
                            recentTrades[playerName] = { marketValue, trades: [] };
                        }
                        recentTrades[playerName].trades.push(tradeValue);
                    });
                }
            });
            
            // Find buy low opportunities (traded below value)
            Object.entries(recentTrades).forEach(([playerName, data]) => {
                if (data.marketValue > 1000 && data.trades.length > 0) {
                    const avgTradeValue = data.trades.reduce((a, b) => a + b, 0) / data.trades.length;
                    
                    if (avgTradeValue < data.marketValue * 0.7 && avgTradeValue > 0) {
                        alerts.push({
                            player: playerName,
                            type: 'buy',
                            marketValue: data.marketValue,
                            tradeValue: Math.round(avgTradeValue),
                            reason: `Recently traded ${Math.round(((data.marketValue - avgTradeValue) / data.marketValue) * 100)}% below market value`
                        });
                    } else if (avgTradeValue > data.marketValue * 1.3) {
                        alerts.push({
                            player: playerName,
                            type: 'sell',
                            marketValue: data.marketValue,
                            tradeValue: Math.round(avgTradeValue),
                            reason: `Recently traded ${Math.round(((avgTradeValue - data.marketValue) / data.marketValue) * 100)}% above market value`
                        });
                    }
                }
            });
            
            return {
                balance: {
                    score: Math.round(balanceScore),
                    rating: balanceRating,
                    strongest,
                    weakest,
                    analysis
                },
                tradeImpact: impactArray,
                playerTrends: {
                    mostTraded,
                    highValue
                },
                alerts: alerts.slice(0, 5)
            };
        }

        function showPowerRankings() {
            document.getElementById('powerRankingsTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg text-sm';
            document.getElementById('tradesTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            document.getElementById('shameTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            document.getElementById('whatIfTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            document.getElementById('analyticsTab').className = 'flex-1 py-3 px-4 rounded-xl font-semibold text-red-200 hover:bg-white/5 border border-red-500/30 text-sm';
            
            // Calculate power rankings
            const rankings = calculatePowerRankings();
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-gradient-to-br from-indigo-900/30 to-purple-900/30 rounded-2xl p-8 border-2 border-indigo-500/30">
                    <div class="text-center mb-8">
                        <div class="text-7xl mb-4">üìà</div>
                        <h2 class="text-5xl font-black text-white mb-2 headline">LEAGUE POWER RANKINGS</h2>
                        <p class="text-indigo-200 text-lg">Roster strength breakdown by position</p>
                    </div>
                    
                    <!-- View Toggle -->
                    <div class="flex justify-center gap-3 mb-8">
                        <button id="barViewBtn" class="px-6 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
                            üìä Bar Chart
                        </button>
                        <button id="heatmapViewBtn" class="px-6 py-3 rounded-xl font-semibold text-indigo-200 hover:bg-white/5 border-2 border-indigo-500/30">
                            üî• Heatmap
                        </button>
                    </div>
                    
                    <!-- Bar Chart View -->
                    <div id="barChartView" class="space-y-6">
                        ${rankings.teams.map((team, idx) => {
                            const totalValue = team.qb + team.rb + team.wr + team.te + team.picks;
                            const maxTotal = rankings.teams[0].qb + rankings.teams[0].rb + rankings.teams[0].wr + rankings.teams[0].te + rankings.teams[0].picks;
                            
                            return `
                                <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-indigo-400/30">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-4">
                                            <div class="text-3xl font-black text-indigo-400">#${idx + 1}</div>
                                            <h3 class="text-2xl font-bold text-white headline">${team.name}</h3>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-white text-3xl font-bold">${totalValue.toLocaleString()}</div>
                                            <div class="text-indigo-300 text-sm">Total Value</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Stacked Bar Chart -->
                                    <div class="relative h-12 bg-slate-800 rounded-lg overflow-hidden mb-3">
                                        <div class="absolute inset-0 flex">
                                            <div class="bg-gradient-to-r from-pink-500 to-pink-600" style="width: ${(team.qb / maxTotal * 100)}%" title="QB: ${team.qb}"></div>
                                            <div class="bg-gradient-to-r from-emerald-500 to-emerald-600" style="width: ${(team.rb / maxTotal * 100)}%" title="RB: ${team.rb}"></div>
                                            <div class="bg-gradient-to-r from-blue-500 to-blue-600" style="width: ${(team.wr / maxTotal * 100)}%" title="WR: ${team.wr}"></div>
                                            <div class="bg-gradient-to-r from-orange-500 to-orange-600" style="width: ${(team.te / maxTotal * 100)}%" title="TE: ${team.te}"></div>
                                            <div class="bg-gradient-to-r from-yellow-500 to-yellow-600" style="width: ${(team.picks / maxTotal * 100)}%" title="Picks: ${team.picks}"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Position Breakdown -->
                                    <div class="grid grid-cols-5 gap-3 text-sm">
                                        <div class="text-center">
                                            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-pink-500 to-pink-600 mx-auto mb-1"></div>
                                            <div class="text-pink-300 font-bold">QB</div>
                                            <div class="text-white font-semibold">${team.qb.toLocaleString()}</div>
                                            <div class="text-gray-400 text-xs">Rank: ${team.qbRank}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-emerald-500 to-emerald-600 mx-auto mb-1"></div>
                                            <div class="text-emerald-300 font-bold">RB</div>
                                            <div class="text-white font-semibold">${team.rb.toLocaleString()}</div>
                                            <div class="text-gray-400 text-xs">Rank: ${team.rbRank}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 mx-auto mb-1"></div>
                                            <div class="text-blue-300 font-bold">WR</div>
                                            <div class="text-white font-semibold">${team.wr.toLocaleString()}</div>
                                            <div class="text-gray-400 text-xs">Rank: ${team.wrRank}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-orange-500 to-orange-600 mx-auto mb-1"></div>
                                            <div class="text-orange-300 font-bold">TE</div>
                                            <div class="text-white font-semibold">${team.te.toLocaleString()}</div>
                                            <div class="text-gray-400 text-xs">Rank: ${team.teRank}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 mx-auto mb-1"></div>
                                            <div class="text-yellow-300 font-bold">DRAFT CAP</div>
                                            <div class="text-white font-semibold">${team.picks > 0 ? team.picks.toLocaleString() : '0'}</div>
                                            <div class="text-gray-400 text-xs">Rank: ${team.picksRank}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Heatmap View -->
                    <div id="heatmapView" class="hidden">
                        <div class="bg-slate-900/60 rounded-xl p-6 border-2 border-indigo-400/30 overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b-2 border-indigo-500/30">
                                        <th class="text-left py-4 px-4 text-indigo-200 font-bold">RANK</th>
                                        <th class="text-left py-4 px-4 text-indigo-200 font-bold">TEAM</th>
                                        <th class="text-center py-4 px-4 text-indigo-200 font-bold">OVERALL</th>
                                        <th class="text-center py-4 px-4 text-pink-300 font-bold">QB</th>
                                        <th class="text-center py-4 px-4 text-emerald-300 font-bold">RB</th>
                                        <th class="text-center py-4 px-4 text-blue-300 font-bold">WR</th>
                                        <th class="text-center py-4 px-4 text-orange-300 font-bold">TE</th>
                                        <th class="text-center py-4 px-4 text-yellow-300 font-bold">DRAFT CAPITAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rankings.teams.map((team, idx) => {
                                        const getRankColor = (rank, total) => {
                                            const pct = (rank - 1) / (total - 1);
                                            if (pct <= 0.2) return 'bg-green-600';
                                            if (pct <= 0.4) return 'bg-lime-600';
                                            if (pct <= 0.6) return 'bg-yellow-600';
                                            if (pct <= 0.8) return 'bg-orange-600';
                                            return 'bg-red-600';
                                        };
                                        
                                        const totalValue = team.qb + team.rb + team.wr + team.te + team.picks;
                                        const numTeams = rankings.teams.length;
                                        
                                        return `
                                            <tr class="border-b border-indigo-500/20 hover:bg-white/5 transition">
                                                <td class="py-4 px-4">
                                                    <div class="text-2xl font-black text-indigo-400">#${idx + 1}</div>
                                                </td>
                                                <td class="py-4 px-4">
                                                    <div class="text-white font-bold text-lg">${team.name}</div>
                                                </td>
                                                <td class="py-4 px-4 text-center">
                                                    <div class="text-white font-bold text-lg">${totalValue.toLocaleString()}</div>
                                                </td>
                                                <td class="py-4 px-4">
                                                    <div class="flex flex-col items-center gap-1">
                                                        <div class="${getRankColor(team.qbRank, numTeams)} text-white font-bold px-4 py-2 rounded-lg min-w-[60px] text-center">
                                                            ${team.qbRank}${team.qbRank === 1 ? 'st' : team.qbRank === 2 ? 'nd' : team.qbRank === 3 ? 'rd' : 'th'}
                                                        </div>
                                                        <div class="text-gray-400 text-xs">${team.qb.toLocaleString()}</div>
                                                    </div>
                                                </td>
                                                <td class="py-4 px-4">
                                                    <div class="flex flex-col items-center gap-1">
                                                        <div class="${getRankColor(team.rbRank, numTeams)} text-white font-bold px-4 py-2 rounded-lg min-w-[60px] text-center">
                                                            ${team.rbRank}${team.rbRank === 1 ? 'st' : team.rbRank === 2 ? 'nd' : team.rbRank === 3 ? 'rd' : 'th'}
                                                        </div>
                                                        <div class="text-gray-400 text-xs">${team.rb.toLocaleString()}</div>
                                                    </div>
                                                </td>
                                                <td class="py-4 px-4">
                                                    <div class="flex flex-col items-center gap-1">
                                                        <div class="${getRankColor(team.wrRank, numTeams)} text-white font-bold px-4 py-2 rounded-lg min-w-[60px] text-center">
                                                            ${team.wrRank}${team.wrRank === 1 ? 'st' : team.wrRank === 2 ? 'nd' : team.wrRank === 3 ? 'rd' : 'th'}
                                                        </div>
                                                        <div class="text-gray-400 text-xs">${team.wr.toLocaleString()}</div>
                                                    </div>
                                                </td>
                                                <td class="py-4 px-4">
                                                    <div class="flex flex-col items-center gap-1">
                                                        <div class="${getRankColor(team.teRank, numTeams)} text-white font-bold px-4 py-2 rounded-lg min-w-[60px] text-center">
                                                            ${team.teRank}${team.teRank === 1 ? 'st' : team.teRank === 2 ? 'nd' : team.teRank === 3 ? 'rd' : 'th'}
                                                        </div>
                                                        <div class="text-gray-400 text-xs">${team.te.toLocaleString()}</div>
                                                    </div>
                                                </td>
                                                <td class="py-4 px-4">
                                                    <div class="flex flex-col items-center gap-1">
                                                        <div class="${getRankColor(team.picksRank, numTeams)} text-white font-bold px-4 py-2 rounded-lg min-w-[60px] text-center">
                                                            ${team.picksRank}${team.picksRank === 1 ? 'st' : team.picksRank === 2 ? 'nd' : team.picksRank === 3 ? 'rd' : 'th'}
                                                        </div>
                                                        <div class="text-gray-400 text-xs">${team.picks.toLocaleString()}</div>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Toggle between views
            document.getElementById('barViewBtn').addEventListener('click', () => {
                document.getElementById('barViewBtn').className = 'px-6 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg';
                document.getElementById('heatmapViewBtn').className = 'px-6 py-3 rounded-xl font-semibold text-indigo-200 hover:bg-white/5 border-2 border-indigo-500/30';
                document.getElementById('barChartView').classList.remove('hidden');
                document.getElementById('heatmapView').classList.add('hidden');
            });
            
            document.getElementById('heatmapViewBtn').addEventListener('click', () => {
                document.getElementById('heatmapViewBtn').className = 'px-6 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg';
                document.getElementById('barViewBtn').className = 'px-6 py-3 rounded-xl font-semibold text-indigo-200 hover:bg-white/5 border-2 border-indigo-500/30';
                document.getElementById('heatmapView').classList.remove('hidden');
                document.getElementById('barChartView').classList.add('hidden');
            });
        }

        function calculatePowerRankings() {
            const teamStats = [];
            
            // First, let's understand what draft picks each team owns
            // We need to track pick ownership from trades
            const pickOwnership = {}; // Key: "season-round-owner_id", Value: current_roster_id
            
            // Process all trades to track current pick ownership
            transactions.forEach(trade => {
                if (trade.draft_picks) {
                    trade.draft_picks.forEach(pick => {
                        const pickKey = `${pick.season}-${pick.round}-${pick.owner_id}`;
                        pickOwnership[pickKey] = pick.roster_id;
                    });
                }
            });
            
            rosters.forEach(roster => {
                const teamName = getOwner(roster.roster_id);
                let qbValue = 0, rbValue = 0, wrValue = 0, teValue = 0, picksValue = 0;
                
                if (roster.players) {
                    roster.players.forEach(playerId => {
                        const player = players[playerId];
                        const value = getPlayerValue(playerId);
                        
                        if (player && value > 0) {
                            if (player.position === 'QB') qbValue += value;
                            else if (player.position === 'RB') rbValue += value;
                            else if (player.position === 'WR') wrValue += value;
                            else if (player.position === 'TE') teValue += value;
                        }
                    });
                }
                
                // Calculate draft capital - check what picks this roster currently owns
                // Go through all possible picks for the next 3 years (2025, 2026, 2027)
                for (let year = 2025; year <= 2027; year++) {
                    for (let round = 1; round <= 4; round++) {
                        // Check all rosters to see if this roster owns their pick
                        rosters.forEach(r => {
                            const pickKey = `${year}-${round}-${r.roster_id}`;
                            const currentOwner = pickOwnership[pickKey];
                            
                            // If this roster owns this pick (either originally or via trade)
                            if (currentOwner === roster.roster_id || 
                                (currentOwner === undefined && r.roster_id === roster.roster_id)) {
                                
                                let baseValue = 0;
                                
                                // Base values by round
                                if (round === 1) {
                                    baseValue = 5000;
                                } else if (round === 2) {
                                    baseValue = 2000;
                                } else if (round === 3) {
                                    baseValue = 800;
                                } else {
                                    baseValue = 300;
                                }
                                
                                // Apply depreciation for future years
                                const yearsOut = year - 2025;
                                if (yearsOut > 0) {
                                    baseValue = Math.round(baseValue * Math.pow(0.9, yearsOut));
                                }
                                
                                picksValue += baseValue;
                            }
                        });
                    }
                }
                
                teamStats.push({
                    name: teamName,
                    qb: qbValue,
                    rb: rbValue,
                    wr: wrValue,
                    te: teValue,
                    picks: picksValue
                });
            });
            
            // Calculate ranks for each position
            const qbRanks = teamStats.map(t => t.qb).sort((a, b) => b - a);
            const rbRanks = teamStats.map(t => t.rb).sort((a, b) => b - a);
            const wrRanks = teamStats.map(t => t.wr).sort((a, b) => b - a);
            const teRanks = teamStats.map(t => t.te).sort((a, b) => b - a);
            const picksRanks = teamStats.map(t => t.picks).sort((a, b) => b - a);
            
            teamStats.forEach(team => {
                team.qbRank = qbRanks.indexOf(team.qb) + 1;
                team.rbRank = rbRanks.indexOf(team.rb) + 1;
                team.wrRank = wrRanks.indexOf(team.wr) + 1;
                team.teRank = teRanks.indexOf(team.te) + 1;
                team.picksRank = picksRanks.indexOf(team.picks) + 1;
            });
            
            // Sort by total value
            teamStats.sort((a, b) => {
                const totalA = a.qb + a.rb + a.wr + a.te + a.picks;
                const totalB = b.qb + b.rb + b.wr + b.te + b.picks;
                return totalB - totalA;
            });
            
            return { teams: teamStats };
        }

        function exportText() {
            const report = `FLEECE FACTORY - ${currentLeague.name}\nTotal Trades: ${transactions.length}\n\n` +
                transactions.map((t, i) => `Trade #${i+1} - Week ${t.leg || 'N/A'} - Score: ${calcScore(t)}/100`).join('\n');
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FleeceFactory_Report.txt';
            a.click();
        }

        function exportCsv() {
            const csv = 'Trade,Week,Score\n' + transactions.map((t, i) => `${i+1},${t.leg || 'N/A'},${calcScore(t)}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FleeceFactory_Trades.csv';
            a.click();
        }

        function showError(msg) {
            document.getElementById('errorMsg').textContent = '‚ùå ' + msg;
            document.getElementById('errorMsg').classList.remove('hidden');
        }
        function hideError() { document.getElementById('errorMsg').classList.add('hidden'); }
        function showLoading() { document.getElementById('loadingMsg').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingMsg').classList.add('hidden'); }
    </script>
</body>

</html>
