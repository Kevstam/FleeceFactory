<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeper Fantasy Football Query Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #581c87 50%, #1e293b 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-6">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-3">üèà Sleeper Fantasy Tool</h1>
            <p class="text-purple-200 text-lg">Track trades, analyze drafts, and dominate your league</p>
        </div>

        <!-- Input Section -->
        <div id="inputSection" class="bg-white/10 backdrop-blur-md rounded-2xl p-8 mb-6 border border-purple-500/20">
            <div class="flex gap-4 mb-6">
                <button onclick="setInputMode('username')" id="usernameBtn" class="px-6 py-2 rounded-lg font-semibold transition-all bg-purple-600 text-white">
                    Use Username
                </button>
                <button onclick="setInputMode('league')" id="leagueBtn" class="px-6 py-2 rounded-lg font-semibold transition-all bg-white/5 text-purple-300 hover:bg-white/10">
                    Use League ID
                </button>
            </div>

            <div id="usernameInput">
                <label class="block text-purple-200 text-sm font-semibold mb-3">Enter Sleeper Username or User ID</label>
                <div class="flex gap-3">
                    <input type="text" id="username" placeholder="YourUsername" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white/10 border border-purple-400/30 text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400">
                    <button onclick="fetchUser()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all">
                        Search
                    </button>
                </div>
            </div>

            <div id="leagueInput" class="hidden">
                <label class="block text-purple-200 text-sm font-semibold mb-3">Enter League ID (Easiest Method!)</label>
                <div class="flex gap-3">
                    <input type="text" id="leagueId" placeholder="1181730976707772416" 
                        class="flex-1 px-4 py-3 rounded-lg bg-white/10 border border-purple-400/30 text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400">
                    <button onclick="fetchByLeagueId()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all">
                        Load League
                    </button>
                </div>
                <p class="text-purple-300 text-sm mt-3">Find your League ID in the URL when viewing your league on Sleeper</p>
            </div>

            <div id="errorMsg" class="mt-4 text-red-400 text-sm hidden"></div>
            <div id="loadingMsg" class="mt-4 text-purple-300 text-sm hidden">Loading...</div>
        </div>

        <!-- League Selection -->
        <div id="leagueSelection" class="hidden bg-white/10 backdrop-blur-md rounded-2xl p-8 mb-6 border border-purple-500/20">
            <h2 class="text-2xl font-bold text-white mb-4">Select a League</h2>
            <div id="leaguesList"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6 border border-purple-500/20">
                <h2 id="leagueName" class="text-2xl font-bold text-white"></h2>
                <p id="leagueInfo" class="text-purple-300 mt-1"></p>
            </div>

            <!-- Tabs -->
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-2 mb-6 border border-purple-500/20 flex gap-2">
                <button onclick="setTab('trades')" id="tradesTab" class="flex-1 py-3 px-6 rounded-xl font-semibold transition-all bg-purple-600 text-white">
                    Trades (<span id="tradesCount">0</span>)
                </button>
                <button onclick="setTab('draft')" id="draftTab" class="flex-1 py-3 px-6 rounded-xl font-semibold transition-all text-purple-200 hover:bg-white/5">
                    Draft Analysis (<span id="draftCount">0</span>)
                </button>
            </div>

            <!-- Search Bar -->
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 mb-6 border border-purple-500/20">
                <input type="text" id="searchInput" placeholder="Search players..." onkeyup="filterData()"
                    class="w-full px-4 py-3 rounded-lg bg-white/10 border border-purple-400/30 text-white placeholder-purple-300/50 focus:outline-none focus:border-purple-400">
            </div>

            <!-- Content Area -->
            <div id="tradesContent"></div>
            <div id="draftContent" class="hidden"></div>
        </div>
    </div>

    <script>
        let players = {};
        let rosters = [];
        let transactions = [];
        let draftPicks = [];
        let currentLeague = null;
        let currentTab = 'trades';
        let userId = null;
        let leagues = [];
        let leagueUsers = {};

        // Load players data
        async function loadPlayers() {
            try {
                const response = await fetch('https://api.sleeper.app/v1/players/nfl');
                players = await response.json();
            } catch (err) {
                console.error('Error loading players:', err);
            }
        }
        loadPlayers();

        function setInputMode(mode) {
            const usernameBtn = document.getElementById('usernameBtn');
            const leagueBtn = document.getElementById('leagueBtn');
            const usernameInput = document.getElementById('usernameInput');
            const leagueInput = document.getElementById('leagueInput');

            if (mode === 'username') {
                usernameBtn.className = 'px-6 py-2 rounded-lg font-semibold transition-all bg-purple-600 text-white';
                leagueBtn.className = 'px-6 py-2 rounded-lg font-semibold transition-all bg-white/5 text-purple-300 hover:bg-white/10';
                usernameInput.classList.remove('hidden');
                leagueInput.classList.add('hidden');
            } else {
                leagueBtn.className = 'px-6 py-2 rounded-lg font-semibold transition-all bg-purple-600 text-white';
                usernameBtn.className = 'px-6 py-2 rounded-lg font-semibold transition-all bg-white/5 text-purple-300 hover:bg-white/10';
                leagueInput.classList.remove('hidden');
                usernameInput.classList.add('hidden');
            }
        }

        function showError(msg) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMsg').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loadingMsg').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingMsg').classList.add('hidden');
        }

        async function fetchUser() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showError('Please enter a username');
                return;
            }

            hideError();
            showLoading();

            try {
                const response = await fetch(`https://api.sleeper.app/v1/user/${username}`);
                if (!response.ok) throw new Error('User not found');
                
                const userData = await response.json();
                userId = userData.user_id;

                const leaguesResponse = await fetch(`https://api.sleeper.app/v1/user/${userId}/leagues/nfl/2024`);
                leagues = await leaguesResponse.json();

                document.getElementById('inputSection').classList.add('hidden');
                displayLeagueSelection();
            } catch (err) {
                showError('User not found. Try using League ID instead.');
            } finally {
                hideLoading();
            }
        }

        async function fetchByLeagueId() {
            const leagueId = document.getElementById('leagueId').value.trim();
            if (!leagueId) {
                showError('Please enter a league ID');
                return;
            }

            hideError();
            showLoading();

            try {
                const response = await fetch(`https://api.sleeper.app/v1/league/${leagueId}`);
                if (!response.ok) throw new Error('League not found');
                
                currentLeague = await response.json();
                document.getElementById('inputSection').classList.add('hidden');
                await loadLeagueData(leagueId);
            } catch (err) {
                showError('League not found. Please check the League ID.');
            } finally {
                hideLoading();
            }
        }

        function displayLeagueSelection() {
            const selection = document.getElementById('leagueSelection');
            const list = document.getElementById('leaguesList');
            
            list.innerHTML = leagues.map(league => `
                <button onclick="selectLeague('${league.league_id}')" 
                    class="w-full p-4 mb-3 bg-white/5 hover:bg-white/10 rounded-xl text-left transition-all border border-purple-400/20 hover:border-purple-400/50">
                    <div class="text-white font-semibold text-lg">${league.name}</div>
                    <div class="text-purple-300 text-sm mt-1">${league.total_rosters} teams</div>
                </button>
            `).join('');

            selection.classList.remove('hidden');
        }

        async function selectLeague(leagueId) {
            showLoading();
            currentLeague = leagues.find(l => l.league_id === leagueId);
            document.getElementById('leagueSelection').classList.add('hidden');
            await loadLeagueData(leagueId);
            hideLoading();
        }

        async function loadLeagueData(leagueId) {
            try {
                // Load users in league
                const usersResponse = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`);
                const users = await usersResponse.json();
                console.log('Users:', users);
                
                // Load rosters
                const rostersResponse = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`);
                rosters = await rostersResponse.json();
                console.log('Rosters:', rosters);

                // Map user IDs to usernames and match with rosters
                leagueUsers = {};
                
                // First create a user lookup by user_id
                const userLookup = {};
                users.forEach(user => {
                    userLookup[user.user_id] = user;
                });
                
                // Then map rosters to usernames
                rosters.forEach(roster => {
                    const user = userLookup[roster.owner_id];
                    console.log(`Roster ${roster.roster_id} owner:`, roster.owner_id, 'User:', user);
                    
                    if (user) {
                        leagueUsers[roster.roster_id] = {
                            username: user.display_name || user.username || user.user_id,
                            userId: user.user_id,
                            teamName: user.metadata?.team_name || null
                        };
                    } else {
                        leagueUsers[roster.roster_id] = {
                            username: `Team ${roster.roster_id}`,
                            userId: null,
                            teamName: null
                        };
                    }
                });
                
                console.log('League users mapping:', leagueUsers);

                // Load transactions
                transactions = [];
                for (let week = 1; week <= 18; week++) {
                    try {
                        const response = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/transactions/${week}`);
                        const data = await response.json();
                        if (data) transactions.push(...data);
                    } catch (err) {}
                }
                transactions = transactions.filter(t => t.type === 'trade');
                console.log('Trades found:', transactions.length);

                // Load draft
                const draftsResponse = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/drafts`);
                const drafts = await draftsResponse.json();
                
                if (drafts && drafts.length > 0) {
                    const picksResponse = await fetch(`https://api.sleeper.app/v1/draft/${drafts[0].draft_id}/picks`);
                    draftPicks = await picksResponse.json() || [];
                }

                displayMainContent();
            } catch (err) {
                showError('Error loading league data: ' + err.message);
            }
        }

        function displayMainContent() {
            document.getElementById('leagueName').textContent = currentLeague.name;
            document.getElementById('leagueInfo').textContent = `${currentLeague.total_rosters} teams`;
            document.getElementById('tradesCount').textContent = transactions.length;
            document.getElementById('draftCount').textContent = draftPicks.length;
            document.getElementById('mainContent').classList.remove('hidden');
            
            displayTrades();
        }

        function setTab(tab) {
            currentTab = tab;
            const tradesTab = document.getElementById('tradesTab');
            const draftTab = document.getElementById('draftTab');
            const tradesContent = document.getElementById('tradesContent');
            const draftContent = document.getElementById('draftContent');

            if (tab === 'trades') {
                tradesTab.className = 'flex-1 py-3 px-6 rounded-xl font-semibold transition-all bg-purple-600 text-white';
                draftTab.className = 'flex-1 py-3 px-6 rounded-xl font-semibold transition-all text-purple-200 hover:bg-white/5';
                tradesContent.classList.remove('hidden');
                draftContent.classList.add('hidden');
                displayTrades();
            } else {
                draftTab.className = 'flex-1 py-3 px-6 rounded-xl font-semibold transition-all bg-purple-600 text-white';
                tradesTab.className = 'flex-1 py-3 px-6 rounded-xl font-semibold transition-all text-purple-200 hover:bg-white/5';
                draftContent.classList.remove('hidden');
                tradesContent.classList.add('hidden');
                displayDraft();
            }
        }

        function getPlayerName(playerId) {
            if (!playerId || !players[playerId]) return 'Unknown Player';
            const player = players[playerId];
            return `${player.first_name} ${player.last_name}`;
        }

        function getRosterOwner(rosterId) {
            if (leagueUsers[rosterId]) {
                return leagueUsers[rosterId].username;
            }
            return `Team ${rosterId}`;
        }

        function filterData() {
            if (currentTab === 'trades') {
                displayTrades();
            } else {
                displayDraft();
            }
        }

        function displayTrades() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = transactions.filter(trade => {
                if (!searchTerm) return true;
                return trade.adds && Object.keys(trade.adds).some(pid => 
                    getPlayerName(pid).toLowerCase().includes(searchTerm)
                );
            });

            const content = document.getElementById('tradesContent');
            
            if (filtered.length === 0) {
                content.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-12 text-center border border-purple-500/20">
                        <p class="text-purple-200 text-lg">No trades found</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = filtered.map(trade => {
                // Get all unique roster IDs involved in the trade
                const involvedRosters = new Set();
                
                // Add rosters from adds
                if (trade.adds) {
                    Object.values(trade.adds).forEach(rosterId => involvedRosters.add(rosterId));
                }
                
                // Add rosters from draft picks
                if (trade.draft_picks) {
                    trade.draft_picks.forEach(pick => {
                        if (pick.roster_id) involvedRosters.add(pick.roster_id);
                        if (pick.owner_id) involvedRosters.add(pick.owner_id);
                    });
                }

                const rosterArray = Array.from(involvedRosters);
                
                // Build trade calculator URLs
                const tradePlayerIds = trade.adds ? Object.keys(trade.adds) : [];
                const ktcUrl = buildKTCUrl(trade, rosterArray);
                const dynastyProcessUrl = buildDynastyProcessUrl(trade, rosterArray);
                
                const sides = rosterArray.map(rosterId => {
                    // Players this roster is receiving
                    const receivingPlayers = trade.adds ? Object.keys(trade.adds).filter(
                        pid => trade.adds[pid] === rosterId
                    ) : [];
                    
                    // Draft picks this roster is receiving
                    const receivingPicks = trade.draft_picks ? trade.draft_picks.filter(
                        p => p.roster_id === rosterId
                    ) : [];
                    
                    if (receivingPlayers.length === 0 && receivingPicks.length === 0) {
                        return '';
                    }
                    
                    return `
                        <div class="bg-gradient-to-br from-purple-900/30 to-blue-900/30 p-4 rounded-xl border border-purple-400/30">
                            <h4 class="text-white font-bold text-lg mb-3 pb-2 border-b border-purple-400/30">
                                ${getRosterOwner(rosterId)} Receives:
                            </h4>
                            <div class="space-y-2">
                                ${receivingPlayers.map(pid => {
                                    const playerName = getPlayerName(pid);
                                    const player = players[pid];
                                    const position = player ? player.position : '';
                                    const team = player ? player.team : '';
                                    
                                    return `
                                        <div class="bg-white/10 p-3 rounded-lg border-l-4 border-green-400">
                                            <div class="text-white font-semibold">${playerName}</div>
                                            ${position || team ? `<div class="text-purple-300 text-sm">${position}${team ? ' - ' + team : ''}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                                ${receivingPicks.map(pick => `
                                    <div class="bg-white/10 p-3 rounded-lg border-l-4 border-yellow-400">
                                        <div class="text-white font-semibold">${pick.season} Round ${pick.round} Pick</div>
                                        <div class="text-purple-300 text-sm">Draft Pick</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).filter(s => s).join('');

                return `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-4 border border-purple-500/20">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-purple-400/30">
                            <div class="text-purple-300 text-sm">
                                Week ${trade.leg || 'N/A'} ‚Ä¢ ${new Date(trade.created).toLocaleDateString()}
                            </div>
                            <div class="text-purple-400 text-xs">
                                ${rosterArray.length} teams involved
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            ${sides}
                        </div>
                        <div class="pt-4 border-t border-purple-400/30">
                            <div class="text-purple-200 text-sm font-semibold mb-3">üìä Check Trade Value:</div>
                            <div class="flex flex-wrap gap-2">
                                <a href="${ktcUrl}" target="_blank" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition-all">
                                    KeepTradeCut Calculator
                                </a>
                                <a href="${dynastyProcessUrl}" target="_blank"
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-all">
                                    DynastyProcess Calculator
                                </a>
                                <a href="https://www.fantasycalc.com/trade-calculator" target="_blank"
                                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-semibold transition-all">
                                    FantasyCalc (Manual Entry)
                                </a>
                            </div>
                            <p class="text-purple-400 text-xs mt-2">
                                Note: Calculator links auto-fill player names. You may need to select correct players and adjust for 2QB/Superflex settings.
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buildKTCUrl(trade, rosterArray) {
            // KTC doesn't have a direct URL API, but we can try to construct with player names
            const baseUrl = 'https://keeptradecut.com/trade-calculator';
            
            // Build query string with player names
            let queryParts = [];
            
            rosterArray.forEach((rosterId, idx) => {
                const receivingPlayers = trade.adds ? Object.keys(trade.adds).filter(
                    pid => trade.adds[pid] === rosterId
                ) : [];
                
                receivingPlayers.forEach(pid => {
                    const playerName = getPlayerName(pid);
                    queryParts.push(`player${idx + 1}=${encodeURIComponent(playerName)}`);
                });
            });
            
            // Return base URL (user will need to search players manually)
            return baseUrl;
        }

        function buildDynastyProcessUrl(trade, rosterArray) {
            // Dynasty Process also requires manual entry
            return 'https://apps.dynastyprocess.com/calculator';
        }

        function displayDraft() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = draftPicks.filter(pick => {
                if (!searchTerm) return true;
                return getPlayerName(pick.player_id).toLowerCase().includes(searchTerm);
            });

            const content = document.getElementById('draftContent');
            
            if (filtered.length === 0) {
                content.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-12 text-center border border-purple-500/20">
                        <p class="text-purple-200 text-lg">No draft picks found</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = filtered.map(pick => `
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-4 border border-purple-500/20">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-semibold text-lg">
                            Pick ${pick.pick_no}: ${getPlayerName(pick.player_id)}
                        </span>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-purple-300">Round:</span>
                            <span class="text-white ml-2">${pick.round}</span>
                        </div>
                        <div>
                            <span class="text-purple-300">Picked by:</span>
                            <span class="text-white ml-2">${getRosterOwner(pick.roster_id)}</span>
                        </div>
                        <div>
                            <span class="text-purple-300">Pick #:</span>
                            <span class="text-white ml-2">${pick.pick_no}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>